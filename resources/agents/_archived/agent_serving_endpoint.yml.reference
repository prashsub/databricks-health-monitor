# Health Monitor Agent - Model Serving Endpoint with On-Behalf-Of (OBO) Authentication
#
# CRITICAL: OBO Authentication Enabled
# - DATABRICKS_USE_IDENTITY_PASSTHROUGH: "true" allows agent to query Genie on behalf of calling user
# - Eliminates permission errors when accessing Genie Spaces
# - Provides proper audit trail (actions logged under user, not endpoint)
#
# Reference: https://docs.databricks.com/en/machine-learning/model-serving/create-manage-serving-endpoints.html

resources:
  model_serving_endpoints:
    health_monitor_agent_endpoint:
      # Simple name to avoid 63 character limit
      # Format: health_monitor_agent_{env} (e.g., health_monitor_agent_dev)
      name: "health_monitor_agent_${bundle.target}"
      
      config:
        served_entities:
          - name: current
            # Unity Catalog model reference
            entity_name: ${var.catalog}.${var.agent_schema}.health_monitor_agent
            # Model version is configurable per environment (workspace-specific)
            entity_version: "${var.agent_model_version}"
            
            # Compute configuration
            workload_size: Small
            scale_to_zero_enabled: true
            
            # ================================================================
            # CRITICAL: On-Behalf-Of (OBO) Authentication
            # ================================================================
            # This environment variable enables identity passthrough,
            # allowing the agent to query Genie Spaces with the calling user's
            # credentials instead of the endpoint service principal.
            #
            # Without this:
            # - ❌ Agent queries as endpoint service principal
            # - ❌ Permission errors on Genie Spaces
            # - ❌ All users see same data
            #
            # With this:
            # - ✅ Agent queries as calling user
            # - ✅ No permission errors (user's own permissions apply)
            # - ✅ User-level data filtering
            # - ✅ Proper audit trail
            # ================================================================
            environment_vars:
              # Enable OBO for Genie queries
              DATABRICKS_USE_IDENTITY_PASSTHROUGH: "true"
              
              # Pass Genie Space IDs to agent
              COST_GENIE_SPACE_ID: ${var.cost_genie_space_id}
              SECURITY_GENIE_SPACE_ID: ${var.security_genie_space_id}
              PERFORMANCE_GENIE_SPACE_ID: ${var.performance_genie_space_id}
              RELIABILITY_GENIE_SPACE_ID: ${var.reliability_genie_space_id}
              QUALITY_GENIE_SPACE_ID: ${var.quality_genie_space_id}
              
              # Application context
              APP_ENVIRONMENT: ${bundle.target}
              APP_VERSION: "v4.0"
        
        # Traffic routing
        traffic_config:
          routes:
            - served_model_name: current
              traffic_percentage: 100
      
      # Permissions
      permissions:
        - level: CAN_QUERY
          group_name: users  # All users can query
        
        - level: CAN_MANAGE
          group_name: data_engineers  # Admins can manage
      
      # Tags (serving endpoints use array format, not map)
      tags:
        - key: environment
          value: ${bundle.target}
        - key: agent_type
          value: multi_domain_genie
        - key: obo_enabled
          value: "true"
