# Master Setup Orchestrator
# ONE-TIME SETUP: Complete infrastructure initialization
# 
# Execution Flow:
# 1. Bronze Setup (create non-streaming tables + DQ rules)
# 2. Gold Setup (create 39 tables + CDF tracking + constraints + alert config)
#
# Total Infrastructure:
#   - Bronze: 8 non-streaming tables + DQ rules table
#   - Gold: 39 domain tables + CDF tracking + 38 constraints + alert config
#
# Usage:
#   databricks bundle run -t dev master_setup_orchestrator
#
# Expected Duration: 20-30 minutes
# Run Once: Initial deployment only

resources:
  jobs:
    master_setup_orchestrator:
      name: "[${bundle.target}] Health Monitor - Master Setup Orchestrator"
      description: "Complete setup: Bronze (8 tables + DQ rules) + Gold (39 tables + CDF + constraints + alerts)"
      
      tasks:
        # Step 1: Bronze Setup (creates non-streaming tables + DQ rules)
        - task_key: bronze_setup
          run_job_task:
            job_id: ${resources.jobs.bronze_setup_job.id}
        
        # Step 2: Gold Setup (creates tables + constraints + alert config)
        - task_key: gold_setup
          depends_on:
            - task_key: bronze_setup
          run_job_task:
            job_id: ${resources.jobs.gold_setup_job.id}
      
      # Timeout: 2 hours for complete setup
      timeout_seconds: 7200
      
      # Email notifications
      email_notifications:
        on_start:
          - data-engineering@company.com
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: databricks_health_monitor
        layer: all
        job_type: setup
        orchestrator: "master"
        compute_type: serverless
        execution_type: "one_time"
