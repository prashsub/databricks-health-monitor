# Dashboard SQL Query Validation Job
# 
# Pre-deployment validation of all dashboard SQL queries.
# Run this BEFORE dashboard_deployment_job to catch errors early.
#
# Validates ALL dashboards in src/dashboards/:
#   - ðŸ’° Cost: cost_management, commit_tracking
#   - âš¡ Performance: query_performance, cluster_utilization, dbr_migration
#   - ðŸ”„ Reliability: job_reliability, job_optimization
#   - ðŸ”’ Security: security_audit, governance_hub
#   - âœ… Quality: table_health
#   - ðŸ“Š Unified: health_monitor_unified
#
# Error Categories Detected:
#   - COLUMN_NOT_FOUND: Invalid column references
#   - AMBIGUOUS_COLUMN: Unqualified column in JOINs
#   - SYNTAX_ERROR: SQL syntax issues
#   - TABLE_NOT_FOUND: Missing tables
#
# Usage (standalone):
#   databricks bundle run -t dev dashboard_validation_job
#
# Note: This runs automatically before deployment in dashboard_deployment_job

resources:
  jobs:
    dashboard_validation_job:
      name: "[${bundle.target}] Health Monitor - Dashboard SQL Validation"
      description: |
        Pre-deployment validation of all dashboard SQL queries.
        Validates queries against Gold layer tables using EXPLAIN.
        Catches column resolution, syntax, and ambiguous reference errors.
        Run this before dashboard deployment to save debugging time.
      
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
      
      tasks:
        - task_key: validate_dashboard_queries
          environment_key: default
          notebook_task:
            notebook_path: ../../src/dashboards/validate_dashboard_queries.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
      
      # Short timeout since validation should be fast
      timeout_seconds: 900  # 15 minutes (increased for full validation)
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
      
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: dashboard
        job_type: validation
        job_level: atomic
        compute_type: serverless

