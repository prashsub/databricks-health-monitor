# Dashboard Deployment Job
# Deploys all Lakeview AI/BI Dashboards for Health Monitor
#
# Workflow:
#   1. Validate SQL queries (catches errors before deployment)
#   2. Deploy 5 domain dashboards (Cost, Performance, Quality, Security, Reliability)
#   3. Deploy unified dashboard (combines overview pages from all domains)
#
# Domain Dashboards:
#   - ðŸ’° Cost: cost_management, commit_tracking
#   - âš¡ Performance: query_performance, cluster_utilization, dbr_migration
#   - ðŸ”„ Reliability: job_reliability, job_optimization
#   - ðŸ”’ Security: security_audit, governance_hub
#   - âœ… Quality: table_health
#
# Unified Dashboard:
#   - Combines overview pages from all domains
#   - Includes global filters for cross-domain analysis
#   - Executive-friendly single entry point
#
# Run after Gold layer and TVF setup
# Reference: https://docs.databricks.com/visualizations/lakeview

resources:
  jobs:
    dashboard_deployment_job:
      name: "[${bundle.target}] Health Monitor - Dashboard Deployment"
      description: |
        Validates and deploys all AI/BI Lakeview dashboards.
        First validates SQL queries, then deploys domain dashboards, then unified dashboard.

      # âœ… MANDATORY: Serverless environment configuration
      environments:
        - environment_key: default
          spec:
            environment_version: "4"

      tasks:
        # Task 1: Validate all SQL queries FIRST (optional - use dashboard_validation_job for standalone validation)
        # - task_key: validate_sql_queries
        #   environment_key: default
        #   notebook_task:
        #     notebook_path: ../../src/dashboards/validate_dashboard_queries.py
        #     base_parameters:
        #       catalog: ${var.catalog}
        #       gold_schema: ${var.gold_schema}

        # Task 2: Deploy all dashboards (domain + unified)
        - task_key: deploy_all_dashboards
          environment_key: default
          notebook_task:
            notebook_path: ../../src/dashboards/deploy_dashboards.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              warehouse_id: ${var.warehouse_id}
              dashboard_folder: ${var.dashboard_folder}  # Workspace folder for dashboards

      # No schedule - run on demand after Gold setup
      # Dashboards refresh automatically based on their queries

      # Timeout: 90 minutes (validation + multiple dashboard deployments)
      timeout_seconds: 5400

      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com

      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: presentation
        job_type: deployment
        compute_type: serverless
