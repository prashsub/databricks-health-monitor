# Dashboard Deployment Job
# Validates and deploys all Lakeview AI/BI Dashboards for Health Monitor
#
# Workflow:
#   1. Validate dashboards (catches whackamole regressions before deployment)
#      - Column name mismatches (duration_ms vs total_duration_ms)
#      - Widget field errors (warehouse vs warehouse_name)
#      - Missing parameters (checks global + dataset level)
#      - Databricks-specific issues (fact_query_history column names)
#   2. Deploy 5 domain dashboards (Cost, Performance, Quality, Security, Reliability)
#   3. Deploy unified dashboard (combines overview pages from all domains)
#
# ‚ö†Ô∏è  Deployment is BLOCKED if validation finds errors
#
# Domain Dashboards:
#   - üí∞ Cost: cost_management, commit_tracking
#   - ‚ö° Performance: query_performance, cluster_utilization, dbr_migration
#   - üîÑ Reliability: job_reliability, job_optimization
#   - üîí Security: security_audit, governance_hub
#   - ‚úÖ Quality: table_health
#
# Unified Dashboard:
#   - Combines overview pages from all domains
#   - Includes global filters for cross-domain analysis
#   - Executive-friendly single entry point
#
# Run after Gold layer and TVF setup
# Reference: https://docs.databricks.com/visualizations/lakeview

resources:
  jobs:
    dashboard_deployment_job:
      name: "[${bundle.target}] Health Monitor - Dashboard Deployment"
      description: |
        Validates and deploys all AI/BI Lakeview dashboards with whackamole prevention.
        
        Validation catches:
        - Column name mismatches (duration_ms vs total_duration_ms)
        - Widget field errors (warehouse vs warehouse_name)  
        - Missing parameters (global + dataset level)
        - Databricks-specific issues
        
        Deployment blocked if validation fails.

      # ‚úÖ MANDATORY: Serverless environment configuration
      environments:
        - environment_key: default
          spec:
            environment_version: "4"

      tasks:
        # Task 1: Validate all dashboards FIRST (prevents whackamole regressions)
        # MODE: Warning-Only with Baseline Tracking (148 errors as of 2026-01-08)
        # - If errors <= 148: Warn but allow deployment (no NEW errors)
        # - If errors > 148: BLOCK deployment (regression detected!)
        # - Automatically switches to full blocking when errors reach 0
        - task_key: validate_dashboards
          environment_key: default
          notebook_task:
            notebook_path: ../../scripts/validate_dashboards_notebook.py
            base_parameters:
              dashboards_dir: src/dashboards

        # Task 2: Deploy all dashboards (domain + unified) - ONLY if validation passes
        - task_key: deploy_all_dashboards
          depends_on:
            - task_key: validate_dashboards
          environment_key: default
          notebook_task:
            notebook_path: ../../src/dashboards/deploy_dashboards.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              warehouse_id: ${var.warehouse_id}
              dashboard_folder: ${var.dashboard_folder}  # Workspace folder for dashboards

      # No schedule - run on demand after Gold setup
      # Dashboards refresh automatically based on their queries

      # Timeout: 90 minutes (validation + multiple dashboard deployments)
      timeout_seconds: 5400

      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com

      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: presentation
        job_type: deployment
        compute_type: serverless
