# Monitoring Layer Setup Job (Composite)
# =======================================
# 
# Layer 2 job that orchestrates all monitoring components.
# References atomic jobs - no notebooks directly.
#
# Execution Flow:
#   1. Lakehouse Monitoring Setup (8 monitors across all agent domains)
#
# Pattern: run_job_task references atomic jobs
# This allows independent testing of monitors while providing
# a single entry point for monitoring layer setup.
#
# Usage:
#   databricks bundle run -t dev monitoring_layer_setup_job
#
# Dependencies: Gold Layer tables must exist

resources:
  jobs:
    monitoring_layer_setup_job:
      name: "[${bundle.target}] Health Monitor - Monitoring Layer Setup"
      description: "Composite job: Sets up all Lakehouse Monitors by referencing atomic jobs"
      
      tasks:
        # ================================================================
        # STEP 1: Create Lakehouse Monitors (8 monitors)
        # ================================================================
        - task_key: setup_lakehouse_monitors
          run_job_task:
            job_id: ${resources.jobs.lakehouse_monitoring_setup_job.id}
      
      # Job-level timeout (90 minutes - monitor creation takes time)
      timeout_seconds: 5400
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: databricks_health_monitor
        layer: monitoring
        job_type: setup
        job_level: composite
        compute_type: serverless

