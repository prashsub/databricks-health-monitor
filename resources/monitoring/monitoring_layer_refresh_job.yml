# Monitoring Layer Refresh Job (Composite)
# =========================================
# 
# Layer 2 job that orchestrates monitoring refresh.
# References atomic jobs - no notebooks directly.
#
# Execution Flow:
#   1. Lakehouse Monitoring Refresh (triggers refresh for all monitors)
#
# Pattern: run_job_task references atomic jobs
#
# Usage:
#   databricks bundle run -t dev monitoring_layer_refresh_job
#
# Dependencies: Monitors must exist (run monitoring_layer_setup_job first)

resources:
  jobs:
    monitoring_layer_refresh_job:
      name: "[${bundle.target}] Health Monitor - Monitoring Layer Refresh"
      description: "Composite job: Refreshes all Lakehouse Monitors by referencing atomic jobs"
      
      tasks:
        # ================================================================
        # STEP 1: Refresh Lakehouse Monitors
        # ================================================================
        - task_key: refresh_lakehouse_monitors
          run_job_task:
            job_id: ${resources.jobs.lakehouse_monitoring_refresh_job.id}
      
      # Job-level timeout (45 minutes)
      timeout_seconds: 2700
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: databricks_health_monitor
        layer: monitoring
        job_type: refresh
        job_level: composite
        compute_type: serverless

