# Alerting Validation Job (Atomic)
# ================================
#
# Pre-deployment validation of all alert SQL queries.
# Should run BEFORE alert deployment to catch:
# - SQL syntax errors
# - Security violations (DROP, DELETE, etc.)
# - Missing table references
#
# If any queries fail validation, the job fails to prevent bad deployments.
#
# Usage:
#   databricks bundle run -t dev alerting_validation_job

resources:
  jobs:
    alerting_validation_job:
      name: "[${bundle.target}] Health Monitor - Alerting Query Validation"
      description: >
        Atomic job: Validates all enabled alert SQL queries before deployment.
        Checks syntax, security patterns, and table references.
        Run before alert deployment to prevent invalid queries.
      
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
      
      tasks:
        - task_key: validate_queries
          environment_key: default
          notebook_task:
            notebook_path: ../../src/alerting/validate_all_queries.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              fail_on_warning: "false"
          timeout_seconds: 900
      
      email_notifications:
        on_failure:
          - data-engineering@company.com
      
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: alerting
        job_type: validation
        job_level: atomic
        compute_type: serverless
