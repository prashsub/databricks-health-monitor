# ML Feature Engineering Pipeline
# Creates and refreshes feature tables for ML model training
# 
# Reference: https://docs.databricks.com/aws/en/dev-tools/bundles/resources

resources:
  jobs:
    ml_feature_pipeline:
      name: "[${bundle.target}] Health Monitor - ML Feature Pipeline"
      description: "Creates and refreshes feature tables in Unity Catalog for ML training"
      
      # Serverless environment
      environments:
        - environment_key: ml_features
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow>=3.0.0"
              - "scikit-learn>=1.3.0"
              - "pandas>=2.0.0"
              - "numpy>=1.24.0"
              - "databricks-feature-engineering"
      
      tasks:
        # Create all feature tables
        - task_key: create_feature_tables
          environment_key: ml_features
          notebook_task:
            notebook_path: ../src/ml/features/create_feature_tables.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.gold_schema}_features
      
      # Schedule: Daily at 1 AM (before training)
      schedule:
        quartz_cron_expression: "0 0 1 * * ?"
        timezone_id: "America/Los_Angeles"
        pause_status: PAUSED
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
      
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: ml
        job_type: feature_engineering
        compute_type: serverless

