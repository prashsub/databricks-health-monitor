# ML Training Pipeline (Standalone - Weekly Schedule)
# ==================================================
#
# Trains all 25 ML models for Databricks Health Monitor.
# Runs SEPARATELY from orchestrators on a weekly schedule.
#
# Schedule: Weekly (Sundays at 2 AM) - PAUSED by default
# First Run: Manual after first Refresh populates Gold data
#
# Agent Domains:
#   - ðŸ’° Cost Agent (6 models)
#   - ðŸ”’ Security Agent (4 models)
#   - âš¡ Performance Agent (7 models)
#   - ðŸ”„ Reliability Agent (5 models)
#   - ðŸ“Š Quality Agent (3 models)
#
# MLflow 3.0 Best Practices:
#   - Unity Catalog Model Registry
#   - Model signatures required
#   - Feature Engineering integration
#
# Usage:
#   # Manual first run (after data exists):
#   databricks bundle run -t dev ml_training_pipeline
#
#   # Enable weekly schedule in prod:
#   # Update pause_status to UNPAUSED
#
# Reference: https://github.com/databricks/bundle-examples

resources:
  jobs:
    ml_training_pipeline:
      name: "[${bundle.target}] Health Monitor - ML Training Pipeline"
      description: "Trains all ML models using MLflow 3.0 and registers to Unity Catalog"
      
      # Shared ML environment with all dependencies
      environments:
        - environment_key: ml_training
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow==3.7.0"        # Pin version for reproducibility
              - "scikit-learn>=1.3.0"
              - "xgboost>=2.0.0"
              - "lightgbm>=4.0.0"
              - "pandas>=2.0.0"
              - "numpy>=1.24.0"
              - "databricks-feature-engineering"
      
      tasks:
        # ========================================
        # ðŸ’° COST AGENT MODELS (6 models)
        # ========================================
        - task_key: train_cost_anomaly_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_cost_anomaly_detector.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_budget_forecaster
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_budget_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_job_cost_optimizer
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_job_cost_optimizer.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_chargeback_attribution
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_chargeback_attribution.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_commitment_recommender
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_commitment_recommender.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_tag_recommender
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/cost/train_tag_recommender.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # ========================================
        # ðŸ”’ SECURITY AGENT MODELS (4 models)
        # ========================================
        - task_key: train_security_threat_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/security/train_security_threat_detector.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_exfiltration_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/security/train_exfiltration_detector.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_privilege_escalation_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/security/train_privilege_escalation.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_user_behavior_baseline
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/security/train_user_behavior_baseline.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # ========================================
        # âš¡ PERFORMANCE AGENT MODELS (7 models)
        # ========================================
        - task_key: train_query_forecaster
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_query_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_warehouse_optimizer
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_warehouse_optimizer.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_performance_regression_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_regression_detector.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_cluster_capacity_planner
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_cluster_capacity_planner.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_dbr_migration_risk_scorer
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_dbr_migration_risk_scorer.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_cache_hit_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_cache_hit_predictor.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_query_optimization_recommender
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/performance/train_query_optimization_recommender.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # ========================================
        # ðŸ”„ RELIABILITY AGENT MODELS (5 models)
        # ========================================
        - task_key: train_failure_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/reliability/train_job_failure_predictor.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_duration_forecaster
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/reliability/train_job_duration_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_sla_breach_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/reliability/train_sla_breach_predictor.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_retry_success_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/reliability/train_retry_success_predictor.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        - task_key: train_pipeline_health_scorer
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/reliability/train_pipeline_health_scorer.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # ========================================
        # ðŸ“Š QUALITY AGENT MODELS (3 models)
        # ========================================
        - task_key: train_drift_detector
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/quality/train_drift_detector.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # NOTE: train_schema_change_predictor REMOVED - system.information_schema doesn't track
        # schema history, so schema_changes_7d is always 0 (cannot train classifier with single class)
        
        - task_key: train_freshness_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/quality/train_freshness_predictor.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
        
        # ========================================
        # MODEL REGISTRATION
        # ========================================
        - task_key: register_all_models
          depends_on:
            - task_key: train_cost_anomaly_detector
            - task_key: train_budget_forecaster
            - task_key: train_job_cost_optimizer
            - task_key: train_chargeback_attribution
            - task_key: train_commitment_recommender
            - task_key: train_tag_recommender
            - task_key: train_security_threat_detector
            - task_key: train_exfiltration_detector
            - task_key: train_privilege_escalation_detector
            - task_key: train_user_behavior_baseline
            - task_key: train_query_forecaster
            - task_key: train_warehouse_optimizer
            - task_key: train_performance_regression_detector
            - task_key: train_cluster_capacity_planner
            - task_key: train_dbr_migration_risk_scorer
            - task_key: train_cache_hit_predictor
            - task_key: train_query_optimization_recommender
            - task_key: train_failure_predictor
            - task_key: train_duration_forecaster
            - task_key: train_sla_breach_predictor
            - task_key: train_retry_success_predictor
            - task_key: train_pipeline_health_scorer
            - task_key: train_drift_detector
            - task_key: train_freshness_predictor
          environment_key: ml_training
          notebook_task:
            notebook_path: ../../src/ml/deployment/register_all_models.py
            base_parameters:
              catalog: ${var.catalog}
              feature_schema: ${var.feature_schema}
      
      # Schedule: Weekly on Sundays at 2 AM (retraining cadence)
      # PAUSED by default - enable after first manual run confirms success
      schedule:
        quartz_cron_expression: "0 0 2 ? * SUN"
        timezone_id: "America/Los_Angeles"
        pause_status: PAUSED
      
      # Timeout: 4 hours for full training
      timeout_seconds: 14400
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com
      
      tags:
        environment: ${bundle.target}
        project: databricks_health_monitor
        layer: ml
        job_type: training
        job_level: atomic
        compute_type: serverless
        schedule: weekly_sunday_2am
