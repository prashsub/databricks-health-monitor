# ML Inference Pipeline - All Models
# Runs batch inference for ALL trained ML models and stores predictions
#
# Storage Architecture:
#   - Feature Tables: ${catalog}.${feature_schema} (e.g., system_gold_features)
#   - Predictions: ${catalog}.${feature_schema}.{model}_predictions
#   - Models: Unity Catalog ${catalog}.${feature_schema}.{model_name}
#
# Models Scored (25 total):
#   - Cost (6): anomaly, budget, job_cost, chargeback, commitment, tag_recommender
#   - Security (4): threat, exfiltration, privilege, user_behavior
#   - Performance (7): query, warehouse, regression, cluster_capacity, dbr_risk, cache_hit, query_optimization
#   - Reliability (5): failure, duration, sla_breach, retry_success, pipeline_health
#   - Quality (3): drift, schema_change, freshness
#
# Reference: https://learn.microsoft.com/en-us/azure/databricks/machine-learning/model-inference/

resources:
  jobs:
    ml_inference_pipeline:
      name: "[${bundle.target}] Health Monitor - ML Batch Inference (All Models)"
      description: "Runs batch inference for all 25 ML models across Cost, Security, Performance, Reliability, and Quality domains"
      
      # Serverless environment with ML dependencies
      environments:
        - environment_key: ml_inference
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow>=3.0.0"
              - "scikit-learn>=1.3.0"
              - "pandas>=2.0.0"
              - "numpy>=1.24.0"
              - "databricks-feature-engineering"
      
      tasks:
        # Comprehensive batch inference for all models
        - task_key: batch_inference_all_models
          environment_key: ml_inference
          notebook_task:
            notebook_path: ../../src/ml/inference/batch_inference_all_models.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
          timeout_seconds: 3600  # 1 hour max
      
      # Schedule: Daily at 3 AM (after training pipeline completes)
      schedule:
        quartz_cron_expression: "0 0 3 * * ?"
        timezone_id: "America/Los_Angeles"
        pause_status: PAUSED
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com
      
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: ml
        job_type: inference
        compute_type: serverless
        models_count: "25"
