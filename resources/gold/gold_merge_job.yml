# Gold Layer MERGE Job - Data Pipeline
# Orchestrates Bronze → Gold data transformation across all domains
# 
# **Domains:**
# - shared: dim_workspace
# - billing: dim_sku, fact_list_prices, fact_usage
# - lakeflow: dim_job, dim_job_task, dim_pipeline, fact_job_run_timeline, fact_job_task_run_timeline, fact_pipeline_update_timeline
# - query_performance: dim_warehouse, fact_query_history, fact_warehouse_events
# - security: fact_audit_logs, fact_assistant_events, fact_clean_room_events, fact_outbound_network
# - compute: dim_node_type, dim_cluster, fact_node_timeline
# - mlflow: dim_experiment, fact_mlflow_runs, fact_mlflow_run_metrics_history
# - model_serving: dim_served_entities, fact_endpoint_usage
# - marketplace: fact_listing_access, fact_listing_funnel
# - governance: fact_column_lineage, fact_table_lineage
# - storage: fact_predictive_optimization
#
# Reference: https://github.com/databricks/bundle-examples/blob/main/knowledge_base/serverless_job/resources/serverless_job.yml

resources:
  jobs:
    gold_merge_job:
      name: "[${bundle.target}] Health Monitor - Gold Layer Data Pipeline"
      description: "Orchestrates Bronze → Gold transformation for all domains with proper dependencies"
      
      # Serverless environment configuration
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies: []
      
      # Job parameters
      parameters:
        - name: catalog
          default: ${var.catalog}
        - name: bronze_schema
          default: ${var.system_bronze_schema}
        - name: gold_schema
          default: ${var.gold_schema}
      
      # Tasks - Execute in dependency order
      tasks:
        # =========================================================================
        # PHASE 1: SHARED & REFERENCE DATA
        # =========================================================================
        
        - task_key: merge_shared
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_shared.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
        
        - task_key: merge_compute_reference
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_compute.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        # =========================================================================
        # PHASE 2: BILLING, LAKEFLOW, QUERY PERFORMANCE (Parallel)
        # =========================================================================
        
        - task_key: merge_billing
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_billing.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        - task_key: merge_lakeflow
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_lakeflow.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        - task_key: merge_query_performance
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_query_performance.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
            - task_key: merge_compute_reference
        
        # =========================================================================
        # PHASE 3: SECURITY (Depends on workspace)
        # =========================================================================
        
        - task_key: merge_security
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_security.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        # =========================================================================
        # PHASE 4: MLFLOW, MODEL SERVING, MARKETPLACE (Parallel)
        # =========================================================================
        
        - task_key: merge_mlflow
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_mlflow.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        - task_key: merge_model_serving
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_model_serving.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        - task_key: merge_marketplace
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_marketplace.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        # =========================================================================
        # PHASE 5: GOVERNANCE, STORAGE (Parallel)
        # =========================================================================
        
        - task_key: merge_governance
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_governance.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
        
        - task_key: merge_storage
          environment_key: default
          notebook_task:
            notebook_path: ../../src/gold/merge_storage.py
            base_parameters:
              catalog: ${var.catalog}
              bronze_schema: ${var.system_bronze_schema}
              gold_schema: ${var.gold_schema}
          depends_on:
            - task_key: merge_shared
      
      # Schedule: Daily at 4 AM (PAUSED in dev by default)
      schedule:
        quartz_cron_expression: "0 0 4 * * ?"
        timezone_id: "America/New_York"
        pause_status: PAUSED  # Enable manually in UI or prod
      
      # Timeout at job level
      timeout_seconds: 14400  # 4 hours
      
      # Email notifications
      email_notifications:
        on_start:
          - prashanth.subrahmanyam@databricks.com
        on_failure:
          - prashanth.subrahmanyam@databricks.com
        on_success:
          - prashanth.subrahmanyam@databricks.com
        on_duration_warning_threshold_exceeded:
          - prashanth.subrahmanyam@databricks.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: databricks_health_monitor
        layer: all
        compute_type: serverless
        job_type: pipeline
        orchestrator: "true"
        owner: platform_operations

