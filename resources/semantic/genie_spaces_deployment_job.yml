# Genie Spaces Deployment Job
# Deploys Genie Spaces programmatically via REST API
#
# Uses Export/Import API format to deploy 2 Genie Spaces:
#   - ðŸ’° Cost: Cost Intelligence Space (cost_intelligence_genie_export.json)
#   - ðŸ”„ Reliability: Job Health Monitor Space (job_health_monitor_genie_export.json)
#
# API Endpoints:
#   - POST /api/2.0/genie/spaces - Create new Genie Space
#   - PATCH /api/2.0/genie/spaces/{space_id} - Update existing Space
#   - GET /api/2.0/genie/spaces - List existing Spaces
#
# Reference:
#   - .cursor/rules/semantic-layer/29-genie-space-export-import-api.mdc
#   - Phase 3 Addendum 3.6 - Genie Spaces
#   - https://docs.databricks.com/api/workspace/genie/createspace

resources:
  jobs:
    genie_spaces_deployment_job:
      name: "[${bundle.target}] Health Monitor - Genie Spaces Deployment"
      description: "Deploys Genie Spaces programmatically using REST API from JSON export files"
      
      # Serverless environment
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
      
      tasks:
        # Task 1: Validate all benchmark SQL queries (catches ALL issues at once)
        - task_key: validate_genie_spaces
          environment_key: default
          notebook_task:
            notebook_path: ../../src/genie/validate_genie_spaces_notebook.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
        
        # Task 2: Deploy all Genie Spaces from JSON exports (only if validation passes)
        - task_key: deploy_genie_spaces
          depends_on:
            - task_key: validate_genie_spaces
          environment_key: default
          notebook_task:
            notebook_path: ../../src/genie/deploy_genie_space.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              warehouse_id: ${var.warehouse_id}
              genie_space_json: ""  # Empty = deploy all *_export.json files
      
      # No schedule - run on demand after semantic layer deployment
      
      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: semantic
        artifact_type: genie_space
        job_type: deployment
        api_driven: "true"



