# Genie Spaces Deployment Job
# Validates and deploys Genie Spaces programmatically via REST API
#
# Pre-Deployment Validation:
#   - Executes all 150 benchmark SQL queries with LIMIT 1
#   - Catches column resolution, table reference, and runtime errors
#   - Fails fast if any SQL errors are found
#
# Deploys 6 Genie Spaces:
#   - üí∞ Cost Intelligence (cost_intelligence_genie_export.json)
#   - üìä Data Quality Monitor (data_quality_monitor_genie_export.json)
#   - üîÑ Job Health Monitor (job_health_monitor_genie_export.json)
#   - ‚ö° Performance (performance_genie_export.json)
#   - üîê Security Auditor (security_auditor_genie_export.json)
#   - üè• Unified Health Monitor (unified_health_monitor_genie_export.json)
#
# API Endpoints:
#   - POST /api/2.0/genie/spaces - Create new Genie Space
#   - PATCH /api/2.0/genie/spaces/{space_id} - Update existing Space
#
# Reference:
#   - https://docs.databricks.com/api/workspace/genie/createspace

resources:
  jobs:
    genie_spaces_deployment_job:
      name: "[${bundle.target}] Health Monitor - Genie Spaces Deployment"
      description: "Validates benchmark SQL and deploys Genie Spaces from JSON export files"

      # Serverless environment
      environments:
        - environment_key: default
          spec:
            environment_version: "4"

      tasks:
        # Task 1: Validate all 150 benchmark SQL queries (catches ALL errors)
        - task_key: validate_benchmark_sql
          description: "Execute all benchmark SQL with LIMIT 1 to catch column/table/runtime errors"
          environment_key: default
          notebook_task:
            notebook_path: ../../src/genie/validate_genie_spaces_notebook.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}

        # Task 2: Deploy all Genie Spaces (only runs if validation passes)
        - task_key: deploy_genie_spaces
          description: "Deploy all 6 Genie Spaces from JSON export files"
          depends_on:
            - task_key: validate_benchmark_sql
          environment_key: default
          notebook_task:
            notebook_path: ../../src/genie/deploy_genie_space.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
              warehouse_id: ${var.warehouse_id}
              genie_space_json: ""  # Empty = deploy all *_export.json files

      # No schedule - run on demand after semantic layer deployment

      # Email notifications
      email_notifications:
        on_failure:
          - data-engineering@company.com
        on_success:
          - data-engineering@company.com

      # Tags
      tags:
        environment: ${bundle.target}
        project: health_monitor
        layer: semantic
        artifact_type: genie_space
        job_type: deployment
        api_driven: "true"
        benchmark_validation: "true"



