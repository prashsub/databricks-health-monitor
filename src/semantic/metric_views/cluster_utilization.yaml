# Metric View: cluster_utilization
# Cluster resource utilization metrics for capacity planning
#
# Source: fact_node_timeline (compute domain)
# Schema validation done against: gold_layer_design/yaml/compute/fact_node_timeline.yaml
#
# Key Business Questions Answered:
#   - Which clusters are underutilized?
#   - What's our average CPU and memory usage?
#   - What node types are we using the most?
#   - How much compute waste do we have?
#   - Which clusters have memory pressure (high swap)?

version: "1.1"
comment: >
  Cluster resource utilization analytics for capacity planning and cost optimization.
  Optimized for Genie natural language queries about CPU, memory, and cluster efficiency.

  DIMENSIONS: Filter and group by cluster, workspace, node type, time hierarchy,
  driver vs worker nodes.

  MEASURES: CPU usage (user/system/wait), memory usage, swap, network I/O,
  underutilization rate, node-hours.

  Example queries:
  - "Which clusters are underutilized?"
  - "What's our average CPU usage by cluster?"
  - "Show memory usage by node type"
  - "How many node-hours were wasted?"
  - "Which clusters have high swap usage?"

source: ${catalog}.${gold_schema}.fact_node_timeline

joins:
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id AND dim_workspace.is_current = true

  - name: dim_cluster
    source: ${catalog}.${gold_schema}.dim_cluster
    'on': source.workspace_id = dim_cluster.workspace_id AND source.cluster_id = dim_cluster.cluster_id AND dim_cluster.is_current = true

dimensions:
  # === Primary Dimensions ===
  - name: utilization_date
    expr: DATE(source.start_time)
    comment: Calendar date of the utilization measurement
    display_name: Date
    synonyms:
      - date
      - day
      - measurement date

  - name: workspace_id
    expr: source.workspace_id
    comment: Workspace identifier for workspace-level filtering
    display_name: Workspace ID
    synonyms:
      - workspace
      - ws id
      - environment id

  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name for reporting
    display_name: Workspace Name
    synonyms:
      - workspace
      - environment

  - name: cluster_id
    expr: source.cluster_id
    comment: Cluster identifier for cluster-level analysis
    display_name: Cluster ID
    synonyms:
      - cluster
      - compute

  - name: cluster_name
    expr: dim_cluster.cluster_name
    comment: Human-readable cluster name for reporting
    display_name: Cluster Name
    synonyms:
      - cluster
      - compute name
      - cluster label

  - name: cluster_source
    expr: dim_cluster.cluster_source
    comment: How the cluster was created (UI, API, JOB)
    display_name: Cluster Source
    synonyms:
      - source
      - creation method

  # === Time Dimensions ===
  - name: year
    expr: YEAR(source.start_time)
    comment: Calendar year for annual analysis
    display_name: Year
    synonyms:
      - calendar year

  - name: quarter
    expr: QUARTER(source.start_time)
    comment: Calendar quarter (1-4)
    display_name: Quarter
    synonyms:
      - q
      - qtr

  - name: month
    expr: MONTH(source.start_time)
    comment: Month number (1-12)
    display_name: Month
    synonyms:
      - calendar month

  - name: week_of_year
    expr: WEEKOFYEAR(source.start_time)
    comment: Week number for weekly analysis
    display_name: Week
    synonyms:
      - week

  - name: day_of_week
    expr: DAYOFWEEK(source.start_time)
    comment: Day of week (1=Sunday) for weekday patterns
    display_name: Day of Week
    synonyms:
      - weekday

  - name: hour_of_day
    expr: HOUR(source.start_time)
    comment: Hour of day (0-23) for time-of-day patterns
    display_name: Hour
    synonyms:
      - hour

  # === Node Dimensions ===
  - name: node_type
    expr: source.node_type
    comment: Cloud instance type (e.g., i3.xlarge, Standard_DS3_v2)
    display_name: Node Type
    synonyms:
      - instance type
      - vm type
      - machine type
      - instance size

  - name: is_driver
    expr: source.driver
    comment: Whether the node is a driver (true) or worker (false)
    display_name: Is Driver
    synonyms:
      - driver
      - driver node

  - name: node_role
    expr: CASE WHEN source.driver THEN 'Driver' ELSE 'Worker' END
    comment: Node role for grouping (Driver or Worker)
    display_name: Node Role
    synonyms:
      - role
      - driver or worker

  # === Blog-Derived Dimensions (Workflow Advisor) ===
  - name: provisioning_status
    expr: >
      CASE
        WHEN source.cpu_user_percent + source.cpu_system_percent > 90
          OR source.mem_used_percent > 85 THEN 'UNDERPROVISIONED'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 20
          AND source.mem_used_percent < 30 THEN 'OVERPROVISIONED'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 50
          AND source.mem_used_percent < 50 THEN 'UNDERUTILIZED'
        ELSE 'OPTIMAL'
      END
    comment: Cluster provisioning status based on CPU/memory utilization (from Workflow Advisor repo)
    display_name: Provisioning Status
    synonyms:
      - sizing status
      - utilization status
      - right-sizing status

  - name: savings_opportunity
    expr: >
      CASE
        WHEN source.cpu_user_percent + source.cpu_system_percent < 20
          AND source.mem_used_percent < 30 THEN 'HIGH'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 40
          AND source.mem_used_percent < 50 THEN 'MEDIUM'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 60
          AND source.mem_used_percent < 60 THEN 'LOW'
        ELSE 'NONE'
      END
    comment: Cost savings opportunity level based on underutilization (from Workflow Advisor repo)
    display_name: Savings Opportunity
    synonyms:
      - cost opportunity
      - right-sizing potential

measures:
  - name: total_node_hours
    expr: COUNT(source.instance_id)
    comment: Total node-hours of compute time (one row per hour per node)
    display_name: Total Node Hours
    format:
      type: number
      abbreviation: compact
    synonyms:
      - node hours
      - compute hours

  - name: unique_nodes
    expr: COUNT(DISTINCT source.instance_id)
    comment: Number of distinct compute nodes used
    display_name: Unique Nodes
    format:
      type: number
      abbreviation: compact
    synonyms:
      - nodes
      - instances

  - name: unique_clusters
    expr: COUNT(DISTINCT source.cluster_id)
    comment: Number of distinct clusters with utilization data
    display_name: Unique Clusters
    format:
      type: number
    synonyms:
      - clusters
      - compute clusters

  - name: avg_cpu_user_pct
    expr: AVG(source.cpu_user_percent)
    comment: Average CPU time in user mode (application workload)
    display_name: Avg CPU User %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu usage
      - user cpu
      - application cpu

  - name: avg_cpu_system_pct
    expr: AVG(source.cpu_system_percent)
    comment: Average CPU time in kernel mode (system overhead)
    display_name: Avg CPU System %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - system cpu
      - kernel cpu

  - name: avg_cpu_wait_pct
    expr: AVG(source.cpu_wait_percent)
    comment: Average CPU time waiting for I/O (disk/network bottleneck indicator)
    display_name: Avg CPU Wait %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - io wait
      - cpu wait
      - disk wait

  - name: avg_cpu_total_pct
    expr: AVG(source.cpu_user_percent + source.cpu_system_percent)
    comment: Average total CPU utilization (user + system)
    display_name: Avg Total CPU %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu utilization
      - total cpu
      - cpu usage

  - name: avg_memory_used_pct
    expr: AVG(source.mem_used_percent)
    comment: Average memory utilization percentage
    display_name: Avg Memory %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - memory usage
      - ram usage
      - memory utilization

  - name: avg_memory_swap_pct
    expr: AVG(source.mem_swap_percent)
    comment: Average swap usage (high values indicate memory pressure)
    display_name: Avg Swap %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - swap usage
      - memory swap

  - name: total_network_sent_gb
    expr: SUM(source.network_sent_bytes) / 1073741824.0
    comment: Total network data sent in gigabytes
    display_name: Network Sent (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - data sent
      - network out
      - egress

  - name: total_network_received_gb
    expr: SUM(source.network_received_bytes) / 1073741824.0
    comment: Total network data received in gigabytes
    display_name: Network Received (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - data received
      - network in
      - ingress

  - name: max_cpu_user_pct
    expr: MAX(source.cpu_user_percent)
    comment: Peak CPU user percentage (for capacity planning)
    display_name: Max CPU User %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - peak cpu
      - max cpu

  - name: max_memory_used_pct
    expr: MAX(source.mem_used_percent)
    comment: Peak memory utilization percentage
    display_name: Max Memory %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - peak memory
      - max memory

  - name: underutilized_node_hours
    expr: SUM(CASE WHEN source.cpu_user_percent < 20 AND source.mem_used_percent < 30 THEN 1 ELSE 0 END)
    comment: Node-hours where both CPU and memory were low (potential right-sizing candidates)
    display_name: Underutilized Hours
    format:
      type: number
      abbreviation: compact
    synonyms:
      - idle hours
      - wasted hours

  - name: underutilization_rate
    expr: (SUM(CASE WHEN source.cpu_user_percent < 20 AND source.mem_used_percent < 30 THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(source.instance_id), 0)
    comment: Percentage of node-hours that were underutilized
    display_name: Underutilization Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - idle rate
      - waste rate

  - name: high_swap_node_hours
    expr: SUM(CASE WHEN source.mem_swap_percent > 10 THEN 1 ELSE 0 END)
    comment: Node-hours with significant swap usage (memory pressure indicator)
    display_name: High Swap Hours
    format:
      type: number
      abbreviation: compact
    synonyms:
      - memory pressure hours

  # === Blog-Derived Measures (Workflow Advisor) ===
  - name: p95_cpu_total_pct
    expr: PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY source.cpu_user_percent + source.cpu_system_percent)
    comment: 95th percentile total CPU utilization for capacity planning (from Workflow Advisor)
    display_name: P95 CPU %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - peak cpu
      - p95 cpu utilization

  - name: p95_memory_used_pct
    expr: PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY source.mem_used_percent)
    comment: 95th percentile memory utilization for capacity planning (from Workflow Advisor)
    display_name: P95 Memory %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - peak memory
      - p95 memory utilization

  - name: cpu_saturation_rate
    expr: (SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent > 90 THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(source.instance_id), 0)
    comment: Percentage of time CPU is saturated (>90%) - high values indicate under-provisioning (from Workflow Advisor)
    display_name: CPU Saturation Rate %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - saturation percentage
      - cpu overload rate

  - name: memory_pressure_rate
    expr: (SUM(CASE WHEN source.mem_used_percent > 85 THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(source.instance_id), 0)
    comment: Percentage of time memory under pressure (>85%) - from Workflow Advisor
    display_name: Memory Pressure Rate %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - memory saturation
      - oom risk rate

  - name: cpu_idle_rate
    expr: (SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent < 20 THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(source.instance_id), 0)
    comment: Percentage of time CPU is idle (<20%) - high values indicate over-provisioning (from Workflow Advisor)
    display_name: CPU Idle Rate %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - idle percentage
      - waste rate

  - name: wasted_capacity_pct
    expr: (100 - AVG(source.cpu_user_percent + source.cpu_system_percent)) * (100 - AVG(source.mem_used_percent)) / 10000
    comment: Combined CPU and memory waste indicator - higher values mean more waste (from Workflow Advisor)
    display_name: Wasted Capacity %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - waste percentage
      - unused capacity

  - name: efficiency_score
    expr: AVG(source.cpu_user_percent + source.cpu_system_percent) * AVG(source.mem_used_percent) / 100
    comment: Combined efficiency score (0-100) - higher is better utilization (from Workflow Advisor)
    display_name: Efficiency Score
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - utilization score
      - efficiency rating

  - name: overprovisioned_node_hours
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent < 20 AND source.mem_used_percent < 30 THEN 1 ELSE 0 END)
    comment: Node-hours where cluster is significantly overprovisioned (from Workflow Advisor)
    display_name: Overprovisioned Hours
    format:
      type: number
      abbreviation: compact
    synonyms:
      - oversized hours
      - wasted capacity hours

  - name: underprovisioned_node_hours
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent > 90 OR source.mem_used_percent > 85 THEN 1 ELSE 0 END)
    comment: Node-hours where cluster is underprovisioned/saturated (from Workflow Advisor)
    display_name: Underprovisioned Hours
    format:
      type: number
      abbreviation: compact
    synonyms:
      - saturated hours
      - constrained hours

