# Metric View: cluster_utilization
# Cluster resource utilization metrics for capacity planning and optimization
#
# Agent Domain: Performance
# Source: fact_node_timeline (compute domain)
# Schema validation done against: gold_layer_design/yaml/compute/fact_node_timeline.yaml
#
# Key Business Questions Answered:
#   - Cluster CPU utilization
#   - Underutilized clusters
#   - Memory usage by cluster
#   - Most expensive clusters
#   - Which clusters are overprovisioned?
#   - Show potential cost savings

version: "1.1"
comment: >
  PURPOSE: Cluster resource utilization metrics for capacity planning and optimization.
  
  BEST FOR: Cluster CPU utilization | Memory usage by cluster | Underutilized clusters | 
  Overprovisioned clusters | Efficiency scores | Potential cost savings
  
  NOT FOR: Right-sizing recommendations (use cluster_efficiency) | Cluster cost (use cost_analytics)
  
  DIMENSIONS: cluster_name, workspace_name, node_type, cluster_type, utilization_tier, savings_opportunity
  
  MEASURES: avg_cpu_utilization, avg_memory_utilization, total_node_hours, efficiency_score, wasted_capacity_hours
  
  SOURCE: fact_node_timeline (compute domain)
  
  JOINS: dim_cluster (cluster metadata), dim_workspace (workspace details)
  
  NOTE: Uses hourly resource utilization metrics. For detailed right-sizing analysis, use cluster_efficiency.

source: ${catalog}.${gold_schema}.fact_node_timeline

joins:
  - name: dim_cluster
    source: ${catalog}.${gold_schema}.dim_cluster
    'on': source.workspace_id = dim_cluster.workspace_id AND source.cluster_id = dim_cluster.cluster_id AND dim_cluster.delete_time IS NULL
  
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id

dimensions:
  # === Primary Dimensions ===
  - name: cluster_id
    expr: source.cluster_id
    comment: Cluster identifier for cluster-level analysis
    display_name: Cluster ID
    synonyms:
      - cluster
  
  - name: cluster_name
    expr: dim_cluster.cluster_name
    comment: Human-readable cluster name
    display_name: Cluster Name
    synonyms:
      - cluster
      - compute
  
  - name: cluster_source
    expr: dim_cluster.cluster_source
    comment: Cluster type (JOB, ALL_PURPOSE, SQL, etc.)
    display_name: Cluster Type
    synonyms:
      - type
      - cluster type
      - compute type
  
  - name: workspace_id
    expr: source.workspace_id
    comment: Workspace identifier
    display_name: Workspace ID
    synonyms:
      - workspace
  
  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name
    display_name: Workspace
    synonyms:
      - workspace
      - environment
  
  - name: node_type
    expr: source.node_type
    comment: Cloud instance type of the node (e.g., m5.xlarge)
    display_name: Node Type
    synonyms:
      - instance type
      - vm type
  
  - name: is_driver
    expr: source.driver
    comment: Whether this is a driver node (true) or worker node (false)
    display_name: Is Driver
    synonyms:
      - driver
      - driver node

  # === Provisioning Status Dimensions (Workflow Advisor Pattern) ===
  - name: provisioning_status
    expr: >
      CASE
        WHEN source.cpu_user_percent + source.cpu_system_percent > 90
          OR source.mem_used_percent > 85 THEN 'UNDERPROVISIONED'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 20
         AND source.mem_used_percent < 30 THEN 'OVERPROVISIONED'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 50
         AND source.mem_used_percent < 50 THEN 'UNDERUTILIZED'
        ELSE 'OPTIMAL'
      END
    comment: Cluster provisioning status based on CPU and memory utilization (OPTIMAL, UNDERUTILIZED, OVERPROVISIONED, UNDERPROVISIONED)
    display_name: Provisioning Status
    synonyms:
      - sizing status
      - utilization status
      - right-sizing status
  
  - name: savings_opportunity
    expr: >
      CASE
        WHEN source.cpu_user_percent + source.cpu_system_percent < 30
         AND source.mem_used_percent < 40 THEN 'HIGH'
        WHEN source.cpu_user_percent + source.cpu_system_percent < 50
         AND source.mem_used_percent < 60 THEN 'MEDIUM'
        ELSE 'LOW'
      END
    comment: Cost savings opportunity level based on underutilization (HIGH, MEDIUM, LOW)
    display_name: Savings Opportunity
    synonyms:
      - cost opportunity
      - right-sizing potential
      - optimization opportunity

  # === Time Dimensions ===
  - name: utilization_date
    expr: DATE(source.start_time)
    comment: Date of utilization measurement
    display_name: Date
    synonyms:
      - date
      - measurement date
  
  - name: year
    expr: YEAR(source.start_time)
    comment: Year of measurement
    display_name: Year
    synonyms:
      - year
  
  - name: month
    expr: MONTH(source.start_time)
    comment: Month number (1-12) of measurement
    display_name: Month
    synonyms:
      - month
  
  - name: week_of_year
    expr: WEEKOFYEAR(source.start_time)
    comment: Week number in year
    display_name: Week
    synonyms:
      - week
  
  - name: hour_of_day
    expr: HOUR(source.start_time)
    comment: Hour of day (0-23) for usage patterns
    display_name: Hour of Day
    synonyms:
      - hour

measures:
  # === CPU Utilization Measures ===
  - name: avg_cpu_utilization
    expr: AVG(source.cpu_user_percent + source.cpu_system_percent)
    comment: Average total CPU utilization percentage (user + system)
    display_name: Avg CPU Utilization
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu
      - cpu usage
      - cpu percent
  
  - name: avg_cpu_user
    expr: AVG(source.cpu_user_percent)
    comment: Average CPU user time percentage (application workload)
    display_name: Avg CPU User
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu user
      - user cpu
  
  - name: avg_cpu_system
    expr: AVG(source.cpu_system_percent)
    comment: Average CPU system time percentage (kernel operations)
    display_name: Avg CPU System
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu system
      - kernel cpu
  
  - name: peak_cpu_utilization
    expr: MAX(source.cpu_user_percent + source.cpu_system_percent)
    comment: Peak CPU utilization observed
    display_name: Peak CPU
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - max cpu
      - highest cpu
  
  - name: avg_cpu_wait
    expr: AVG(source.cpu_wait_percent)
    comment: Average CPU wait percentage (I/O bound indicator)
    display_name: Avg CPU Wait
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cpu wait
      - io wait
      - cpu io

  # === Memory Utilization Measures ===
  - name: avg_memory_utilization
    expr: AVG(source.mem_used_percent)
    comment: Average memory utilization percentage
    display_name: Avg Memory Utilization
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - memory
      - mem
      - ram usage
  
  - name: peak_memory_utilization
    expr: MAX(source.mem_used_percent)
    comment: Peak memory utilization observed
    display_name: Peak Memory
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - max memory
      - highest memory
  
  - name: avg_swap_usage
    expr: AVG(source.mem_swap_percent)
    comment: Average memory swap percentage (indicates memory pressure)
    display_name: Avg Swap Usage
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - swap
      - memory swap
      - swap usage

  # === Network Measures ===
  - name: total_network_sent_gb
    expr: SUM(source.network_sent_bytes) / (1024.0*1024.0*1024.0)
    comment: Total data sent over network in gigabytes
    display_name: Network Sent (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - network out
      - data sent
  
  - name: total_network_received_gb
    expr: SUM(source.network_received_bytes) / (1024.0*1024.0*1024.0)
    comment: Total data received over network in gigabytes
    display_name: Network Received (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - network in
      - data received

  # === Time Measures ===
  - name: total_node_hours
    expr: SUM(TIMESTAMPDIFF(MINUTE, source.start_time, source.end_time) / 60.0)
    comment: Total node runtime hours
    display_name: Node Hours
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - hours
      - runtime
      - compute hours

  # === Efficiency Measures (Workflow Advisor Pattern) ===
  - name: wasted_capacity_pct
    expr: (100 - AVG(source.cpu_user_percent + source.cpu_system_percent)) * (100 - AVG(source.mem_used_percent)) / 10000.0
    comment: Combined CPU and memory waste percentage - lower is better
    display_name: Wasted Capacity %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - waste percentage
      - unused capacity
      - idle capacity
  
  - name: resource_efficiency_score
    expr: AVG(source.cpu_user_percent + source.cpu_system_percent) * AVG(source.mem_used_percent) / 100.0
    comment: Combined efficiency score (0-100) - higher means better utilization
    display_name: Efficiency Score
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - utilization score
      - efficiency rating
  
  - name: potential_savings_pct
    expr: >
      CASE
        WHEN AVG(source.cpu_user_percent + source.cpu_system_percent) < 30 THEN 50
        WHEN AVG(source.cpu_user_percent + source.cpu_system_percent) < 50 THEN 30
        WHEN AVG(source.cpu_user_percent + source.cpu_system_percent) < 70 THEN 15
        ELSE 0
      END
    comment: Estimated potential cost savings percentage from right-sizing
    display_name: Potential Savings %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 0
    synonyms:
      - savings estimate
      - cost reduction opportunity

  - name: underprovisioned_hours
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent > 90 THEN TIMESTAMPDIFF(MINUTE, source.start_time, source.end_time) / 60.0 ELSE 0 END)
    comment: Hours of CPU saturation (>90% utilization)
    display_name: Saturated Hours
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - overloaded time
      - high utilization hours
  
  - name: wasted_hours
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent < 20 THEN TIMESTAMPDIFF(MINUTE, source.start_time, source.end_time) / 60.0 ELSE 0 END)
    comment: Hours of significant underutilization (<20% CPU)
    display_name: Wasted Hours
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - idle time
      - unused capacity hours

  # === Entity Count Measures ===
  - name: unique_nodes
    expr: COUNT(DISTINCT source.instance_id)
    comment: Number of unique node instances
    display_name: Node Count
    format:
      type: number
    synonyms:
      - nodes
      - instances
  
  - name: unique_clusters
    expr: COUNT(DISTINCT source.cluster_id)
    comment: Number of unique clusters with utilization data
    display_name: Clusters
    format:
      type: number
    synonyms:
      - cluster count

  - name: measurement_count
    expr: COUNT(*)
    comment: Number of utilization measurements/samples
    display_name: Measurements
    format:
      type: number
      abbreviation: compact
    synonyms:
      - samples
      - data points

  # === Overprovisioned/Underprovisioned Counts ===
  - name: overprovisioned_samples
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent < 20 AND source.mem_used_percent < 30 THEN 1 ELSE 0 END)
    comment: Number of samples indicating overprovisioning
    display_name: Overprovisioned Samples
    format:
      type: number
    synonyms:
      - idle samples
      - overprovisioned count

  - name: underprovisioned_samples
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent > 90 OR source.mem_used_percent > 85 THEN 1 ELSE 0 END)
    comment: Number of samples indicating underprovisioning
    display_name: Underprovisioned Samples
    format:
      type: number
    synonyms:
      - saturated samples
      - underprovisioned count

  - name: optimal_samples
    expr: SUM(CASE WHEN source.cpu_user_percent + source.cpu_system_percent BETWEEN 50 AND 80 AND source.mem_used_percent BETWEEN 50 AND 80 THEN 1 ELSE 0 END)
    comment: Number of samples indicating optimal utilization
    display_name: Optimal Samples
    format:
      type: number
    synonyms:
      - healthy samples
      - optimal count
