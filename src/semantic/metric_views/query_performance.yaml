# Metric View: query_performance
# SQL Warehouse query performance and efficiency metrics
#
# Agent Domain: Performance
# Source: fact_query_history (query_performance domain)
# Schema validation done against: gold_layer_design/yaml/query_performance/fact_query_history.yaml
#
# Key Business Questions Answered:
#   - Average query duration
#   - Slowest queries today
#   - Warehouse query count
#   - Query efficiency by user
#   - P95/P99 latency metrics
#   - Queries with high spill

version: "1.1"
comment: |
  - PURPOSE: SQL Warehouse query performance and efficiency metrics for optimization
  - BEST FOR: "Average query duration" "P95/P99 latency by warehouse" "Query throughput" "Queries with high spill" "Slowest queries today"
  - NOT FOR: Real-time query monitoring (use get_slow_queries TVF), cost per query (use cost_analytics)
  - DIMENSIONS: execution_date, warehouse_name, user_name, statement_type, execution_status, efficiency_tier, spill_tier
  - MEASURES: total_queries, avg_duration_ms, p95_duration_ms, p99_duration_ms, success_rate, queries_per_minute, bytes_spilled
  - SOURCE: fact_query_history (query_performance domain)
  - JOINS: dim_warehouse (warehouse details), dim_workspace (workspace details)
  - NOTE: Duration metrics exclude queue time. For queue analysis, use queue_duration_ms measures.

source: ${catalog}.${gold_schema}.fact_query_history

joins:
  - name: dim_warehouse
    source: ${catalog}.${gold_schema}.dim_warehouse
    'on': source.workspace_id = dim_warehouse.workspace_id AND source.compute_warehouse_id = dim_warehouse.warehouse_id AND dim_warehouse.delete_time IS NULL
  
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id

dimensions:
  # === Primary Dimensions ===
  - name: statement_id
    expr: source.statement_id
    comment: Unique identifier for this query execution
    display_name: Statement ID
    synonyms:
      - query id
      - execution id
  
  - name: warehouse_id
    expr: source.compute_warehouse_id
    comment: SQL Warehouse identifier (flattened from compute struct)
    display_name: Warehouse ID
    synonyms:
      - warehouse
  
  - name: warehouse_name
    expr: dim_warehouse.warehouse_name
    comment: Human-readable SQL Warehouse name
    display_name: Warehouse Name
    synonyms:
      - warehouse
      - sql warehouse
  
  - name: warehouse_size
    expr: dim_warehouse.warehouse_size
    comment: Warehouse T-shirt size (2X-Small to 4X-Large)
    display_name: Warehouse Size
    synonyms:
      - size
      - t-shirt size

  - name: warehouse_tier
    expr: >
      CASE
        WHEN dim_warehouse.warehouse_size IN ('2X-Small', 'X-Small', 'Small') THEN 'SMALL'
        WHEN dim_warehouse.warehouse_size IN ('Medium', 'Large') THEN 'MEDIUM'
        WHEN dim_warehouse.warehouse_size IN ('X-Large', '2X-Large', '3X-Large', '4X-Large') THEN 'LARGE'
        ELSE 'UNKNOWN'
      END
    comment: Warehouse size tier for comparative SLA analysis (SMALL, MEDIUM, LARGE)
    display_name: Warehouse Tier
    synonyms:
      - size category
      - warehouse class
  
  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Workspace where query was executed
    display_name: Workspace
    synonyms:
      - workspace
      - environment

  # === Query Type Dimensions ===
  - name: statement_type
    expr: source.statement_type
    comment: Query type (SELECT, INSERT, MERGE, CREATE, ALTER, etc.)
    display_name: Statement Type
    synonyms:
      - query type
      - statement
      - sql type
  
  - name: execution_status
    expr: source.execution_status
    comment: Execution result status (FINISHED, FAILED, CANCELED)
    display_name: Execution Status
    synonyms:
      - status
      - result
  
  - name: client_application
    expr: source.client_application
    comment: Client application that ran the query (Databricks SQL, Tableau, Power BI, etc.)
    display_name: Client Application
    synonyms:
      - application
      - client
      - tool

  # === Query Efficiency Dimensions (DBSQL Warehouse Advisor Pattern) ===
  - name: query_efficiency_status
    expr: >
      CASE
        WHEN COALESCE(source.spilled_local_bytes, 0) > 100000000 THEN 'HIGH_SPILL'
        WHEN source.waiting_at_capacity_duration_ms > source.total_duration_ms * 0.1 THEN 'HIGH_QUEUE'
        WHEN source.total_duration_ms > 300000 THEN 'SLOW'
        ELSE 'EFFICIENT'
      END
    comment: Query efficiency classification (EFFICIENT, SLOW, HIGH_QUEUE, HIGH_SPILL)
    display_name: Efficiency Status
    synonyms:
      - query status
      - performance status
      - health
  
  - name: is_from_cache
    expr: source.from_result_cache
    comment: Whether query result was served from cache
    display_name: From Cache
    synonyms:
      - cached
      - cache hit

  # === User Dimensions ===
  - name: executed_by
    expr: source.executed_by
    comment: User who executed the query
    display_name: Executed By
    synonyms:
      - user
      - query user
      - run by
  
  - name: executed_as
    expr: source.executed_as
    comment: Identity used for query authorization
    display_name: Executed As
    synonyms:
      - run as
      - authorization identity

  # === Time Dimensions ===
  - name: query_date
    expr: DATE(source.start_time)
    comment: Date query was executed
    display_name: Query Date
    synonyms:
      - date
      - execution date
  
  - name: year
    expr: YEAR(source.start_time)
    comment: Year of query execution
    display_name: Year
    synonyms:
      - year
  
  - name: month
    expr: MONTH(source.start_time)
    comment: Month number (1-12) of query execution
    display_name: Month
    synonyms:
      - month
  
  - name: week_of_year
    expr: WEEKOFYEAR(source.start_time)
    comment: Week number in year
    display_name: Week
    synonyms:
      - week
  
  - name: hour_of_day
    expr: HOUR(source.start_time)
    comment: Hour query was executed (0-23) for usage patterns
    display_name: Hour of Day
    synonyms:
      - hour
      - start hour

measures:
  # === Primary Count Measures ===
  - name: total_queries
    expr: COUNT(*)
    comment: Total number of queries executed
    display_name: Total Queries
    format:
      type: number
      abbreviation: compact
    synonyms:
      - query count
      - queries
      - executions
  
  - name: successful_queries
    expr: SUM(CASE WHEN source.execution_status = 'FINISHED' THEN 1 ELSE 0 END)
    comment: Number of successfully completed queries
    display_name: Successful Queries
    format:
      type: number
      abbreviation: compact
    synonyms:
      - successful
      - completed

  - name: failed_queries
    expr: SUM(CASE WHEN source.execution_status = 'FAILED' THEN 1 ELSE 0 END)
    comment: Number of failed queries
    display_name: Failed Queries
    format:
      type: number
      abbreviation: compact
    synonyms:
      - failures
      - errors

  - name: cached_queries
    expr: SUM(CASE WHEN source.from_result_cache = TRUE THEN 1 ELSE 0 END)
    comment: Number of queries served from result cache
    display_name: Cached Queries
    format:
      type: number
      abbreviation: compact
    synonyms:
      - cache hits

  # === Duration Measures ===
  - name: avg_duration_seconds
    expr: AVG(source.total_duration_ms / 1000.0)
    comment: Average query duration in seconds
    display_name: Avg Duration (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - average duration
      - avg runtime
      - typical query time
  
  - name: p50_duration_seconds
    expr: PERCENTILE(source.total_duration_ms / 1000.0, 0.5)
    comment: Median (50th percentile) query duration in seconds
    display_name: Median Duration (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - median
      - p50
  
  - name: p95_duration_seconds
    expr: PERCENTILE(source.total_duration_ms / 1000.0, 0.95)
    comment: 95th percentile query duration in seconds
    display_name: P95 Duration (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - p95
      - 95th percentile
  
  - name: p99_duration_seconds
    expr: PERCENTILE(source.total_duration_ms / 1000.0, 0.99)
    comment: 99th percentile query duration in seconds for strict SLA tracking
    display_name: P99 Duration (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - p99
      - 99th percentile
      - p99 latency

  - name: max_duration_seconds
    expr: MAX(source.total_duration_ms / 1000.0)
    comment: Maximum query duration in seconds
    display_name: Max Duration (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - slowest query
      - max runtime

  - name: total_duration_hours
    expr: SUM(source.total_duration_ms / 1000.0 / 3600.0)
    comment: Total cumulative query duration in hours
    display_name: Total Duration (hrs)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - total runtime
      - aggregate duration

  # === Queue Time Measures ===
  - name: avg_queue_time_seconds
    expr: AVG(source.waiting_at_capacity_duration_ms / 1000.0)
    comment: Average time queries waited in queue (waiting_at_capacity)
    display_name: Avg Queue Time (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - queue time
      - wait time
      - avg wait

  - name: p95_queue_time_seconds
    expr: PERCENTILE(source.waiting_at_capacity_duration_ms / 1000.0, 0.95)
    comment: 95th percentile queue time in seconds
    display_name: P95 Queue Time (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - p95 wait
      - 95th percentile queue

  - name: p99_queue_time_seconds
    expr: PERCENTILE(source.waiting_at_capacity_duration_ms / 1000.0, 0.99)
    comment: 99th percentile queue time - identifies worst-case waits
    display_name: P99 Queue Time (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - p99 wait time
      - worst case queue

  - name: avg_compile_time_seconds
    expr: AVG(source.compilation_duration_ms / 1000.0)
    comment: Average time spent compiling queries
    display_name: Avg Compile Time (sec)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - compile time
      - compilation time

  # === Data Scan Measures ===
  - name: total_bytes_read_tb
    expr: SUM(source.read_bytes) / (1024.0*1024.0*1024.0*1024.0)
    comment: Total data read in terabytes
    display_name: Data Read (TB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - bytes read
      - data scanned
      - tb read

  - name: avg_bytes_read_gb
    expr: AVG(source.read_bytes) / (1024.0*1024.0*1024.0)
    comment: Average data read per query in gigabytes
    display_name: Avg Data Read (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - avg scan size
      - average bytes

  - name: total_rows_read
    expr: SUM(source.read_rows)
    comment: Total rows read across all queries
    display_name: Total Rows Read
    format:
      type: number
      abbreviation: compact
    synonyms:
      - rows scanned
      - rows read

  # === Spill Measures ===
  - name: avg_bytes_spilled_gb
    expr: AVG(COALESCE(source.spilled_local_bytes, 0) / (1024.0*1024.0*1024.0))
    comment: Average data spilled to local disk in GB
    display_name: Avg Spill (GB)
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - spill
      - disk spill
      - local spill

  - name: queries_with_spill
    expr: SUM(CASE WHEN COALESCE(source.spilled_local_bytes, 0) > 0 THEN 1 ELSE 0 END)
    comment: Number of queries that spilled to disk
    display_name: Queries with Spill
    format:
      type: number
    synonyms:
      - spill count
      - spilled queries

  - name: spill_rate
    expr: (SUM(CASE WHEN COALESCE(source.spilled_local_bytes, 0) > 0 THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of queries that spilled to disk
    display_name: Spill Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - spill percentage

  # === Efficiency Measures (DBSQL Warehouse Advisor Pattern) ===
  - name: inefficient_query_count
    expr: >
      COUNT(CASE
        WHEN COALESCE(source.spilled_local_bytes, 0) > 100000000
          OR source.waiting_at_capacity_duration_ms > 30000
          OR source.total_duration_ms > 300000
        THEN 1
      END)
    comment: Count of queries with efficiency issues (high spill, high queue, or slow)
    display_name: Inefficient Queries
    format:
      type: number
    synonyms:
      - problem queries
      - queries needing optimization
  
  - name: efficiency_rate
    expr: >
      (1 - COUNT(CASE
        WHEN COALESCE(source.spilled_local_bytes, 0) > 100000000
          OR source.waiting_at_capacity_duration_ms > 30000
          OR source.total_duration_ms > 300000
        THEN 1
      END) * 1.0 / NULLIF(COUNT(*), 0)) * 100
    comment: Percentage of queries without efficiency issues
    display_name: Efficiency Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - query health rate
      - performance rate

  - name: cache_hit_rate
    expr: (SUM(CASE WHEN source.from_result_cache = TRUE THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of queries served from result cache
    display_name: Cache Hit Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - cache rate
      - cache efficiency

  - name: avg_queue_to_execution_ratio
    expr: AVG(source.waiting_at_capacity_duration_ms * 100.0 / NULLIF(source.total_duration_ms, 0))
    comment: Average ratio of queue time to total execution time - lower is better
    display_name: Queue/Execution Ratio
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - queue ratio
      - wait percentage

  # === Entity Count Measures ===
  - name: unique_users
    expr: COUNT(DISTINCT source.executed_by)
    comment: Number of unique users executing queries
    display_name: Unique Users
    format:
      type: number
    synonyms:
      - user count
      - users
  
  - name: unique_warehouses
    expr: COUNT(DISTINCT source.compute_warehouse_id)
    comment: Number of unique warehouses with query activity
    display_name: Warehouses
    format:
      type: number
    synonyms:
      - warehouse count

  # === Time-Windowed Measures ===
  - name: queries_today
    expr: COUNT(CASE WHEN DATE(source.start_time) = CURRENT_DATE() THEN 1 END)
    comment: Number of queries executed today
    display_name: Queries Today
    format:
      type: number
    synonyms:
      - today's queries

  - name: queries_last_7_days
    expr: COUNT(CASE WHEN source.start_time >= DATE_ADD(CURRENT_DATE(), -7) THEN 1 END)
    comment: Number of queries in last 7 days
    display_name: Queries (7d)
    format:
      type: number
      abbreviation: compact
    synonyms:
      - weekly queries
