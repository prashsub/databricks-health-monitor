# Metric View: job_performance
# Job execution performance metrics for reliability and efficiency analysis
#
# Agent Domain: Reliability
# Source: fact_job_run_timeline (lakeflow domain)
# Schema validation done against: gold_layer_design/yaml/lakeflow/fact_job_run_timeline.yaml
#
# Key Business Questions Answered:
#   - What is our job success rate?
#   - Show failed jobs today
#   - Which jobs are slowest?
#   - Job failure rate by workspace
#   - What's the average job duration?
#   - Show jobs with performance regression

version: "1.1"
comment: >
  PURPOSE: Job execution performance metrics for reliability and efficiency analysis.
  
  BEST FOR: Job success rate | Failed jobs today | Slowest jobs | Job failure rate by workspace | 
  Performance regression detection | Timeout analysis
  
  NOT FOR: Real-time job monitoring (use get_failed_jobs TVF) | Job cost (use cost_analytics)
  
  DIMENSIONS: run_date, job_name, workspace_name, result_state, termination_type, duration_tier, error_category
  
  MEASURES: success_rate, failure_rate, avg_duration_seconds, p95_duration_seconds, total_runs, unique_jobs
  
  SOURCE: fact_job_run_timeline (lakeflow domain)
  
  JOINS: dim_job (job metadata), dim_workspace (workspace details)
  
  NOTE: Duration excludes queue time. For queue analysis, filter by termination_type.

source: ${catalog}.${gold_schema}.fact_job_run_timeline

joins:
  - name: dim_job
    source: ${catalog}.${gold_schema}.dim_job
    'on': source.workspace_id = dim_job.workspace_id AND source.job_id = dim_job.job_id AND dim_job.delete_time IS NULL
  
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id

dimensions:
  # === Primary Dimensions ===
  - name: job_id
    expr: source.job_id
    comment: Unique job identifier within workspace
    display_name: Job ID
    synonyms:
      - job
      - job identifier
  
  - name: job_name
    expr: dim_job.name
    comment: Human-readable job name from job definition
    display_name: Job Name
    synonyms:
      - job
      - workflow
      - workflow name
  
  - name: run_id
    expr: source.run_id
    comment: Unique run identifier for this job execution
    display_name: Run ID
    synonyms:
      - execution id
      - run identifier
  
  - name: run_name
    expr: source.run_name
    comment: User-supplied run name for this job execution
    display_name: Run Name
    synonyms:
      - execution name

  # === Result Dimensions ===
  - name: result_state
    expr: source.result_state
    comment: Job result (SUCCESS, FAILED, ERROR, TIMED_OUT, CANCELLED)
    display_name: Result State
    synonyms:
      - status
      - result
      - outcome
  
  - name: termination_code
    expr: source.termination_code
    comment: Detailed termination reason code
    display_name: Termination Code
    synonyms:
      - error code
      - failure reason
      - exit code

  # === Outcome Category (Blog Pattern) ===
  - name: outcome_category
    expr: >
      CASE
        WHEN source.result_state = 'SUCCESS' THEN 'SUCCESS'
        WHEN source.result_state IN ('ERRORED', 'ERROR', 'FAILED') THEN 'FAILURE'
        WHEN source.result_state = 'TIMED_OUT' THEN 'TIMEOUT'
        WHEN source.result_state = 'CANCELLED' THEN 'CANCELLED'
        WHEN source.result_state IS NULL THEN 'RUNNING'
        ELSE 'OTHER'
      END
    comment: Grouped outcome category for simplified analysis (SUCCESS, FAILURE, TIMEOUT, CANCELLED, RUNNING, OTHER)
    display_name: Outcome
    synonyms:
      - result category
      - job outcome
      - outcome type

  - name: is_success
    expr: source.is_success
    comment: Boolean flag indicating successful completion (pre-calculated in Gold layer)
    display_name: Is Success
    synonyms:
      - successful
      - passed

  # === Trigger & Run Type ===
  - name: trigger_type
    expr: source.trigger_type
    comment: Type of trigger that started the run (PERIODIC, ONE_TIME, RETRY, FILE_ARRIVAL, TABLE)
    display_name: Trigger Type
    synonyms:
      - trigger
      - schedule type
      - run trigger
  
  - name: run_type
    expr: source.run_type
    comment: Type of job run (JOB_RUN, SUBMIT_RUN, WORKFLOW_RUN)
    display_name: Run Type
    synonyms:
      - execution type

  # === Workspace & Owner ===
  - name: workspace_id
    expr: source.workspace_id
    comment: Workspace identifier where job ran
    display_name: Workspace ID
    synonyms:
      - workspace
      - environment id
  
  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name
    display_name: Workspace
    synonyms:
      - workspace
      - environment

  # === Time Dimensions ===
  - name: run_date
    expr: source.run_date
    comment: Calendar date of job run (pre-calculated from period_start_time)
    display_name: Run Date
    synonyms:
      - date
      - execution date
  
  - name: year
    expr: YEAR(source.run_date)
    comment: Calendar year of run
    display_name: Year
    synonyms:
      - year
  
  - name: month
    expr: MONTH(source.run_date)
    comment: Month number (1-12) of run
    display_name: Month
    synonyms:
      - month
  
  - name: week_of_year
    expr: WEEKOFYEAR(source.run_date)
    comment: Week number in year
    display_name: Week
    synonyms:
      - week
  
  - name: day_of_week
    expr: DAYOFWEEK(source.run_date)
    comment: Day of week number (1=Sunday)
    display_name: Day of Week
    synonyms:
      - weekday
  
  - name: hour_of_day
    expr: HOUR(source.period_start_time)
    comment: Hour of day when job started (0-23)
    display_name: Start Hour
    synonyms:
      - hour
      - start time hour

measures:
  # === Primary Measures ===
  - name: total_runs
    expr: COUNT(*)
    comment: Total number of job runs
    display_name: Total Runs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - runs
      - executions
      - run count
  
  - name: successful_runs
    expr: SUM(CASE WHEN source.is_success = TRUE THEN 1 ELSE 0 END)
    comment: Number of successful job runs (uses pre-calculated is_success flag)
    display_name: Successful Runs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - successes
      - passed
      - successful executions
  
  - name: failed_runs
    expr: SUM(CASE WHEN source.result_state IN ('FAILED', 'ERROR', 'ERRORED') THEN 1 ELSE 0 END)
    comment: Number of failed job runs (FAILED or ERROR state)
    display_name: Failed Runs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - failures
      - errors
      - failed

  - name: timed_out_runs
    expr: SUM(CASE WHEN source.result_state = 'TIMED_OUT' THEN 1 ELSE 0 END)
    comment: Number of job runs that timed out
    display_name: Timed Out Runs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - timeouts
      - timed out

  - name: cancelled_runs
    expr: SUM(CASE WHEN source.result_state = 'CANCELLED' THEN 1 ELSE 0 END)
    comment: Number of cancelled job runs
    display_name: Cancelled Runs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - cancellations
      - cancelled

  # === Rate Measures ===
  - name: success_rate
    expr: (SUM(CASE WHEN source.is_success = TRUE THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of successful runs (uses pre-calculated is_success flag)
    display_name: Success Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - success percentage
      - pass rate
      - reliability
  
  - name: failure_rate
    expr: (SUM(CASE WHEN source.is_success = FALSE OR source.is_success IS NULL THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of non-successful runs (inverse of is_success flag)
    display_name: Failure Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - failure percentage
      - error rate
      - unreliability

  - name: timeout_rate
    expr: (SUM(CASE WHEN source.result_state = 'TIMED_OUT' THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of runs that timed out
    display_name: Timeout Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - timeout percentage

  # === Duration Measures ===
  - name: avg_duration_minutes
    expr: AVG(source.run_duration_minutes)
    comment: Average job run duration in minutes (uses pre-calculated run_duration_minutes)
    display_name: Avg Duration (min)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - average runtime
      - avg runtime
      - typical duration
  
  - name: p50_duration_minutes
    expr: PERCENTILE(source.run_duration_minutes, 0.5)
    comment: Median (50th percentile) job run duration in minutes
    display_name: Median Duration (min)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - median runtime
      - p50 duration
  
  - name: p95_duration_minutes
    expr: PERCENTILE(source.run_duration_minutes, 0.95)
    comment: 95th percentile job run duration in minutes
    display_name: P95 Duration (min)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - p95 runtime
      - 95th percentile

  - name: p99_duration_minutes
    expr: PERCENTILE(source.run_duration_minutes, 0.99)
    comment: 99th percentile job run duration in minutes (for strict SLA tracking)
    display_name: P99 Duration (min)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - p99 runtime
      - 99th percentile

  - name: max_duration_minutes
    expr: MAX(source.run_duration_minutes)
    comment: Maximum job run duration in minutes
    display_name: Max Duration (min)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - longest run
      - max runtime

  - name: total_runtime_hours
    expr: SUM(source.run_duration_minutes) / 60
    comment: Total cumulative runtime in hours (uses pre-calculated run_duration_minutes)
    display_name: Total Runtime (hrs)
    format:
      type: number
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - total hours
      - cumulative runtime
      - aggregate runtime

  # === Entity Count Measures ===
  - name: unique_jobs
    expr: COUNT(DISTINCT source.job_id)
    comment: Number of unique jobs run
    display_name: Unique Jobs
    format:
      type: number
    synonyms:
      - job count
      - distinct jobs

  - name: unique_workspaces
    expr: COUNT(DISTINCT source.workspace_id)
    comment: Number of workspaces with job runs
    display_name: Workspaces
    format:
      type: number
    synonyms:
      - workspace count

  # === Time-Windowed Measures ===
  - name: runs_today
    expr: COUNT(CASE WHEN source.run_date = CURRENT_DATE() THEN 1 END)
    comment: Number of job runs today
    display_name: Runs Today
    format:
      type: number
    synonyms:
      - today's runs
      - daily runs

  - name: failures_today
    expr: SUM(CASE WHEN source.run_date = CURRENT_DATE() AND source.result_state IN ('FAILED', 'ERROR', 'ERRORED') THEN 1 ELSE 0 END)
    comment: Number of failed job runs today
    display_name: Failures Today
    format:
      type: number
    synonyms:
      - today's failures

  - name: runs_last_7_days
    expr: COUNT(CASE WHEN source.run_date >= DATE_ADD(CURRENT_DATE(), -7) THEN 1 END)
    comment: Number of job runs in last 7 days
    display_name: Runs (7d)
    format:
      type: number
      abbreviation: compact
    synonyms:
      - weekly runs
      - last week runs

  - name: success_rate_7d
    expr: >
      (SUM(CASE WHEN source.run_date >= DATE_ADD(CURRENT_DATE(), -7) AND source.is_success = TRUE THEN 1 ELSE 0 END) * 100.0) /
      NULLIF(COUNT(CASE WHEN source.run_date >= DATE_ADD(CURRENT_DATE(), -7) THEN 1 END), 0)
    comment: Success rate over last 7 days
    display_name: Success Rate (7d)
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - weekly success rate
      - 7 day reliability
