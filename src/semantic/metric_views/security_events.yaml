# Metric View: security_events
# Security and audit analytics for compliance and access monitoring
#
# Agent Domain: Security
# Source: fact_audit_logs (security domain)
# Schema validation done against: gold_layer_design/yaml/security/fact_audit_logs.yaml
#
# Key Business Questions Answered:
#   - Who accessed this resource?
#   - Security events by user
#   - Failed access attempts today
#   - Sensitive actions in last 24 hours
#   - Most active users by security events
#   - Event trend over time

version: "1.1"
comment: '
- PURPOSE: Security and audit event analytics for compliance and access monitoring
- BEST FOR: "Who accessed this resource" "Security events by user" "Failed access attempts" "Sensitive actions in last 24 hours" "High-risk event analysis"
- NOT FOR: Real-time security alerts (use get_security_events TVF), data lineage (use governance_analytics)
- DIMENSIONS: event_date, service_name, action_name, user_identity, risk_level, response_status, audit_level
- MEASURES: total_events, failed_events, success_rate, events_24h, events_7d, high_risk_events, unique_users
- SOURCE: fact_audit_logs (security domain)
- JOINS: dim_workspace (workspace details)
- NOTE: Excludes system service accounts. For complete audit trail, query fact_audit_logs directly.
'

source: ${catalog}.${gold_schema}.fact_audit_logs

joins:
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id AND dim_workspace.is_current = true

dimensions:
  # === Primary Dimensions ===
  - name: event_id
    expr: source.event_id
    comment: Unique identifier for the audit event
    display_name: Event ID
    synonyms:
      - audit id
      - event identifier
  
  - name: service_name
    expr: source.service_name
    comment: Databricks service that generated the event (accounts, clusters, workspace, sql, etc.)
    display_name: Service
    synonyms:
      - service
      - databricks service
  
  - name: action_name
    expr: source.action_name
    comment: Action performed (create, delete, update, getSecret, etc.)
    display_name: Action
    synonyms:
      - action
      - operation
      - activity
  
  - name: audit_level
    expr: source.audit_level
    comment: Audit level (ACCOUNT_LEVEL or WORKSPACE_LEVEL)
    display_name: Audit Level
    synonyms:
      - level
      - scope
  
  - name: response_status
    expr: source.response_status_code
    comment: HTTP response status code (200=success, 4xx/5xx=error)
    display_name: Status Code
    synonyms:
      - status
      - http status

  # === User Dimensions ===
  - name: user_email
    expr: source.user_identity_email
    comment: Email of user or service principal who performed the action
    display_name: User
    synonyms:
      - user
      - email
      - identity
      - performed by
  
  - name: user_type
    expr: >
      CASE
        WHEN source.user_identity_email LIKE 'system.%' THEN 'SYSTEM'
        WHEN source.user_identity_email LIKE 'databricks-%' THEN 'PLATFORM'
        WHEN source.user_identity_email LIKE '%service-principal%' OR source.user_identity_email LIKE '%@databricks.com' THEN 'SERVICE_PRINCIPAL'
        WHEN source.user_identity_email LIKE '%@%' THEN 'HUMAN_USER'
        ELSE 'UNKNOWN'
      END
    comment: User type classification for filtering system vs human activity
    display_name: User Type
    synonyms:
      - account type
      - user classification
      - identity type
  
  - name: is_human_user
    expr: >
      CASE
        WHEN source.user_identity_email NOT LIKE 'system.%'
         AND source.user_identity_email NOT LIKE 'databricks-%'
         AND source.user_identity_email LIKE '%@%'
         AND source.user_identity_email NOT LIKE '%service-principal%'
        THEN 'Yes' ELSE 'No'
      END
    comment: Flag for human users (excludes system and service accounts)
    display_name: Human User
    synonyms:
      - real user
      - human activity

  # === Security Classification Dimensions ===
  - name: is_sensitive_action
    expr: source.is_sensitive_action
    comment: Whether this is a security-sensitive action (permission changes, secrets, etc.)
    display_name: Is Sensitive
    synonyms:
      - sensitive
      - security sensitive
      - high risk action
  
  - name: is_failed_action
    expr: source.is_failed_action
    comment: Whether this action failed (4xx/5xx status or error message)
    display_name: Is Failed
    synonyms:
      - failed
      - error
      - unsuccessful

  - name: action_category
    expr: >
      CASE
        WHEN source.action_name LIKE '%create%' OR source.action_name LIKE '%add%' THEN 'CREATE'
        WHEN source.action_name LIKE '%delete%' OR source.action_name LIKE '%remove%' THEN 'DELETE'
        WHEN source.action_name LIKE '%update%' OR source.action_name LIKE '%edit%' OR source.action_name LIKE '%modify%' THEN 'UPDATE'
        WHEN source.action_name LIKE '%get%' OR source.action_name LIKE '%list%' OR source.action_name LIKE '%read%' THEN 'READ'
        WHEN source.action_name LIKE '%grant%' OR source.action_name LIKE '%revoke%' THEN 'PERMISSION'
        WHEN source.action_name LIKE '%login%' OR source.action_name LIKE '%logout%' OR source.action_name LIKE '%auth%' THEN 'AUTHENTICATION'
        ELSE 'OTHER'
      END
    comment: High-level action category (CREATE, READ, UPDATE, DELETE, PERMISSION, AUTHENTICATION, OTHER)
    display_name: Action Category
    synonyms:
      - category
      - action type
      - operation type

  # === Workspace Dimensions ===
  - name: workspace_id
    expr: source.workspace_id
    comment: Workspace identifier (0 for account-level events)
    display_name: Workspace ID
    synonyms:
      - workspace
  
  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name
    display_name: Workspace
    synonyms:
      - workspace
      - environment

  # === Network Dimensions ===
  - name: source_ip
    expr: source.source_ip_address
    comment: IP address from which the request originated
    display_name: Source IP
    synonyms:
      - ip
      - ip address
      - client ip

  # === Time Dimensions ===
  - name: event_date
    expr: source.event_date
    comment: Calendar date of the event
    display_name: Event Date
    synonyms:
      - date
      - day
  
  - name: year
    expr: YEAR(source.event_time)
    comment: Year of event
    display_name: Year
    synonyms:
      - year
  
  - name: month
    expr: MONTH(source.event_time)
    comment: Month number (1-12) of event
    display_name: Month
    synonyms:
      - month
  
  - name: week_of_year
    expr: WEEKOFYEAR(source.event_time)
    comment: Week number in year
    display_name: Week
    synonyms:
      - week
  
  - name: hour_of_day
    expr: HOUR(source.event_time)
    comment: Hour of day (0-23) for usage patterns
    display_name: Hour of Day
    synonyms:
      - hour

measures:
  # === Primary Count Measures ===
  - name: total_events
    expr: COUNT(*)
    comment: Total number of audit events
    display_name: Total Events
    format:
      type: number
      abbreviation: compact
    synonyms:
      - events
      - audit events
      - count
  
  - name: successful_events
    expr: SUM(CASE WHEN source.response_status_code >= 200 AND source.response_status_code < 400 THEN 1 ELSE 0 END)
    comment: Number of successful events (2xx/3xx status)
    display_name: Successful Events
    format:
      type: number
      abbreviation: compact
    synonyms:
      - successful
      - success count
  
  - name: failed_events
    expr: SUM(CASE WHEN source.is_failed_action = TRUE THEN 1 ELSE 0 END)
    comment: Number of failed events (uses pre-calculated is_failed_action)
    display_name: Failed Events
    format:
      type: number
      abbreviation: compact
    synonyms:
      - failures
      - errors
      - failed count
  
  - name: sensitive_events
    expr: SUM(CASE WHEN source.is_sensitive_action = TRUE THEN 1 ELSE 0 END)
    comment: Number of sensitive security events (uses pre-calculated is_sensitive_action)
    display_name: Sensitive Events
    format:
      type: number
      abbreviation: compact
    synonyms:
      - sensitive actions
      - high risk events

  # === Rate Measures ===
  - name: failure_rate
    expr: (SUM(CASE WHEN source.is_failed_action = TRUE THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of events that failed
    display_name: Failure Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - error rate
      - failure percentage
  
  - name: sensitive_rate
    expr: (SUM(CASE WHEN source.is_sensitive_action = TRUE THEN 1 ELSE 0 END) * 100.0) / NULLIF(COUNT(*), 0)
    comment: Percentage of events that are security-sensitive
    display_name: Sensitive Rate
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - sensitive percentage
      - high risk rate

  # === Time-Windowed Measures (GitHub Audit Logs Pattern) ===
  - name: events_24h
    expr: COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 24 HOURS THEN 1 END)
    comment: Events in last 24 hours for anomaly detection baseline
    display_name: Events (24h)
    format:
      type: number
      abbreviation: compact
    synonyms:
      - daily events
      - recent events
      - today's events

  - name: events_7d
    expr: COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 7 DAYS THEN 1 END)
    comment: Events in last 7 days
    display_name: Events (7d)
    format:
      type: number
      abbreviation: compact
    synonyms:
      - weekly events
      - last week events
  
  - name: failed_events_24h
    expr: SUM(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 24 HOURS AND source.is_failed_action = TRUE THEN 1 ELSE 0 END)
    comment: Failed events in last 24 hours
    display_name: Failed (24h)
    format:
      type: number
    synonyms:
      - recent failures
      - today's failures
  
  - name: sensitive_events_24h
    expr: SUM(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 24 HOURS AND source.is_sensitive_action = TRUE THEN 1 ELSE 0 END)
    comment: Sensitive events in last 24 hours for security monitoring
    display_name: Sensitive (24h)
    format:
      type: number
    synonyms:
      - recent sensitive
      - today's sensitive

  - name: events_prior_24h
    expr: COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 48 HOURS AND source.event_time < CURRENT_TIMESTAMP() - INTERVAL 24 HOURS THEN 1 END)
    comment: Events in prior 24-hour period (for comparison)
    display_name: Events (Prior 24h)
    format:
      type: number
      abbreviation: compact
    synonyms:
      - yesterday's events
      - prior day events

  - name: event_growth_rate
    expr: >
      (COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 24 HOURS THEN 1 END) -
       COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 48 HOURS AND source.event_time < CURRENT_TIMESTAMP() - INTERVAL 24 HOURS THEN 1 END)) * 100.0 /
      NULLIF(COUNT(CASE WHEN source.event_time >= CURRENT_TIMESTAMP() - INTERVAL 48 HOURS AND source.event_time < CURRENT_TIMESTAMP() - INTERVAL 24 HOURS THEN 1 END), 0)
    comment: 24-hour event growth rate compared to prior 24 hours
    display_name: Event Growth %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - growth rate
      - day over day
      - dod change

  # === Action Category Counts ===
  - name: permission_changes
    expr: SUM(CASE WHEN source.action_name LIKE '%grant%' OR source.action_name LIKE '%revoke%' THEN 1 ELSE 0 END)
    comment: Number of permission change events (grants/revokes)
    display_name: Permission Changes
    format:
      type: number
    synonyms:
      - grants
      - revokes
      - access changes
  
  - name: delete_operations
    expr: SUM(CASE WHEN source.action_name LIKE '%delete%' OR source.action_name LIKE '%remove%' THEN 1 ELSE 0 END)
    comment: Number of delete/remove operations
    display_name: Delete Operations
    format:
      type: number
    synonyms:
      - deletes
      - removals
  
  - name: authentication_events
    expr: SUM(CASE WHEN source.action_name LIKE '%login%' OR source.action_name LIKE '%logout%' OR source.action_name LIKE '%auth%' THEN 1 ELSE 0 END)
    comment: Number of authentication-related events
    display_name: Auth Events
    format:
      type: number
    synonyms:
      - logins
      - logouts
      - auth events

  # === Entity Count Measures ===
  - name: unique_users
    expr: COUNT(DISTINCT source.user_identity_email)
    comment: Number of unique users/identities
    display_name: Unique Users
    format:
      type: number
    synonyms:
      - user count
      - users
      - identities
  
  - name: unique_human_users
    expr: COUNT(DISTINCT CASE WHEN source.user_identity_email NOT LIKE 'system.%' AND source.user_identity_email NOT LIKE 'databricks-%' AND source.user_identity_email LIKE '%@%' THEN source.user_identity_email END)
    comment: Number of unique human users (excluding system accounts)
    display_name: Human Users
    format:
      type: number
    synonyms:
      - real users
      - people
  
  - name: unique_services
    expr: COUNT(DISTINCT source.service_name)
    comment: Number of unique services with events
    display_name: Services
    format:
      type: number
    synonyms:
      - service count

  - name: unique_actions
    expr: COUNT(DISTINCT source.action_name)
    comment: Number of unique action types
    display_name: Actions
    format:
      type: number
    synonyms:
      - action count
      - operation types
  
  - name: unique_ips
    expr: COUNT(DISTINCT source.source_ip_address)
    comment: Number of unique source IP addresses
    display_name: Unique IPs
    format:
      type: number
    synonyms:
      - ip count
      - client ips
