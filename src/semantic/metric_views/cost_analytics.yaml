# Metric View: cost_analytics
# Comprehensive cost analytics metrics for Databricks billing and usage analysis
#
# Agent Domain: Cost
# Source: fact_usage (billing domain)
# Schema validation done against: gold_layer_design/yaml/billing/fact_usage.yaml
#
# Key Business Questions Answered:
#   - What is our total spend this month?
#   - Show cost by workspace
#   - Which SKU costs the most?
#   - Daily cost trend for last 30 days
#   - What percentage of our spend is tagged?
#   - Show cost by team/project tag

version: "1.1"
comment: '
- PURPOSE: Comprehensive cost analytics for Databricks billing and usage analysis
- BEST FOR: "Total spend by workspace" "Cost trend over time" "SKU cost breakdown" "Tagged vs untagged spend" "Serverless vs classic cost"
- NOT FOR: Commit/contract tracking (use commit_tracking), real-time cost alerts (use get_daily_cost_summary TVF)
- DIMENSIONS: usage_date, workspace_name, sku_name, owner, tag_team, tag_project, is_serverless, billing_origin_product
- MEASURES: total_cost, total_dbu, cost_7d, cost_30d, tag_coverage_pct, serverless_pct, wow_growth, mom_growth
- SOURCE: fact_usage (billing domain)
- JOINS: dim_workspace (workspace details)
- NOTE: Cost values are list prices. Custom tags accessed via custom_tags MAP column.
'

source: ${catalog}.${gold_schema}.fact_usage

joins:
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id AND dim_workspace.is_current = true

dimensions:
  # === Primary Dimensions ===
  - name: usage_date
    expr: source.usage_date
    comment: Date of usage record for time-based filtering and trending
    display_name: Usage Date
    synonyms:
      - date
      - day
      - billing date

  - name: usage_month
    expr: DATE_TRUNC('month', source.usage_date)
    comment: First day of the usage month for monthly analysis
    display_name: Usage Month
    synonyms:
      - month
      - billing month
  
  - name: workspace_id
    expr: source.workspace_id
    comment: Databricks workspace identifier for workspace-level cost analysis
    display_name: Workspace ID
    synonyms:
      - workspace
      - environment id
      - ws id
  
  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name for reporting
    display_name: Workspace Name
    synonyms:
      - workspace
      - environment
      - env name
  
  - name: cloud
    expr: source.cloud
    comment: Cloud provider (AWS, Azure, GCP) for multi-cloud analysis
    display_name: Cloud
    synonyms:
      - cloud provider
      - provider
  
  - name: sku_name
    expr: source.sku_name
    comment: Product SKU category (JOBS_COMPUTE, SQL, etc.) for product-level analysis
    display_name: SKU Name
    synonyms:
      - sku
      - product
      - service
      - product type
  
  - name: billing_origin_product
    expr: source.billing_origin_product
    comment: Product that originated the usage (JOBS, SQL, DLT, etc.)
    display_name: Product
    synonyms:
      - product
      - origin product
      - billing product

  # === Entity Type Classification (Dashboard Pattern) ===
  - name: entity_type
    expr: >
      CONCAT_WS(' ',
        CASE WHEN source.product_features_is_serverless THEN 'SERVERLESS' ELSE 'CLASSIC' END,
        CASE
          WHEN source.billing_origin_product = 'JOBS' THEN 'JOB'
          WHEN source.billing_origin_product IN ('DLT', 'LAKEFLOW_CONNECT') THEN 'PIPELINE'
          WHEN source.billing_origin_product = 'SQL' AND source.usage_metadata_dlt_pipeline_id IS NOT NULL THEN 'PIPELINE'
          WHEN source.billing_origin_product = 'SQL' THEN 'WAREHOUSE'
          ELSE source.billing_origin_product
        END)
    comment: Classification of workload by serverless status and product type (e.g., SERVERLESS JOB, CLASSIC WAREHOUSE)
    display_name: Entity Type
    synonyms:
      - workload type
      - compute type
      - serverless status
  
  - name: is_serverless
    expr: source.product_features_is_serverless
    comment: Whether usage is from serverless compute (true/false)
    display_name: Is Serverless
    synonyms:
      - serverless
      - serverless compute

  # === Owner Dimensions ===
  - name: run_as
    expr: source.identity_metadata_run_as
    comment: User or service principal who ran the workload (flattened from identity_metadata)
    display_name: Run As User
    synonyms:
      - owner
      - user
      - run by
      - executed by
  
  - name: owned_by
    expr: source.identity_metadata_owned_by
    comment: Resource owner for chargeback attribution (flattened from identity_metadata)
    display_name: Owner
    synonyms:
      - resource owner
      - owned by
  
  - name: job_name
    expr: source.usage_metadata_job_name
    comment: Job name for job-level cost attribution (flattened from usage_metadata)
    display_name: Job Name
    synonyms:
      - job
      - workflow

  # === Tag Dimensions for Cost Attribution ===
  - name: tag_status
    expr: CASE WHEN source.is_tagged = TRUE THEN 'Tagged' ELSE 'Untagged' END
    comment: Whether the usage record has custom tags for cost attribution (uses pre-calculated is_tagged flag)
    display_name: Tag Status
    synonyms:
      - tagged
      - has tags
      - tag coverage
  
  - name: team_tag
    expr: COALESCE(source.custom_tags['team'], 'Unassigned')
    comment: Team tag value for chargeback reporting
    display_name: Team
    synonyms:
      - team
      - department
      - business unit
      - team tag
  
  - name: project_tag
    expr: COALESCE(source.custom_tags['project'], 'Unassigned')
    comment: Project tag value for cost allocation
    display_name: Project
    synonyms:
      - project
      - initiative
      - project tag
  
  - name: cost_center_tag
    expr: COALESCE(source.custom_tags['cost_center'], 'Unassigned')
    comment: Cost center tag for financial reporting
    display_name: Cost Center
    synonyms:
      - cost center
      - cc
      - cost_center
  
  - name: env_tag
    expr: COALESCE(source.custom_tags['env'], source.custom_tags['environment'], 'Unknown')
    comment: Environment tag (dev, staging, prod) for environment-level analysis
    display_name: Environment Tag
    synonyms:
      - environment
      - env
      - stage

  # === Time Dimensions ===
  - name: year
    expr: YEAR(source.usage_date)
    comment: Calendar year for annual analysis
    display_name: Year
    synonyms:
      - calendar year
  
  - name: quarter
    expr: QUARTER(source.usage_date)
    comment: Calendar quarter (1-4) for quarterly analysis
    display_name: Quarter
    synonyms:
      - q
      - qtr
  
  - name: month
    expr: MONTH(source.usage_date)
    comment: Month number (1-12) for monthly analysis
    display_name: Month
    synonyms:
      - month number
  
  - name: week_of_year
    expr: WEEKOFYEAR(source.usage_date)
    comment: Week number in year for weekly analysis
    display_name: Week
    synonyms:
      - week
      - week number
  
  - name: day_of_week
    expr: DAYOFWEEK(source.usage_date)
    comment: Day of week number (1=Sunday) for day-of-week analysis
    display_name: Day of Week
    synonyms:
      - weekday

measures:
  # === Primary Measures ===
  - name: total_dbu
    expr: SUM(source.usage_quantity)
    comment: Total Databricks Units (DBUs) consumed
    display_name: Total DBUs
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - dbu
      - dbus
      - units
      - usage
      - databricks units
  
  - name: total_cost
    expr: SUM(source.list_cost)
    comment: Total estimated cost in USD (pre-calculated from list_price * usage_quantity)
    display_name: Total Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - cost
      - spend
      - spending
      - dollars
      - amount
  
  - name: avg_daily_cost
    expr: SUM(source.list_cost) / NULLIF(COUNT(DISTINCT source.usage_date), 0)
    comment: Average daily cost (total cost / distinct days)
    display_name: Avg Daily Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - daily average
      - average cost
      - avg cost
      - daily burn rate

  - name: cost_per_dbu
    expr: SUM(source.list_cost) / NULLIF(SUM(source.usage_quantity), 0)
    comment: Average cost per DBU (effective blended rate)
    display_name: Cost per DBU
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 4
    synonyms:
      - dbu rate
      - unit cost
      - effective rate

  # === Entity Count Measures ===
  - name: active_workspaces
    expr: COUNT(DISTINCT source.workspace_id)
    comment: Number of workspaces with usage
    display_name: Active Workspaces
    format:
      type: number
    synonyms:
      - workspace count
      - workspaces
  
  - name: active_users
    expr: COUNT(DISTINCT source.identity_metadata_run_as)
    comment: Number of unique users/principals with usage
    display_name: Active Users
    format:
      type: number
    synonyms:
      - user count
      - users
      - principals
  
  - name: active_jobs
    expr: COUNT(DISTINCT source.usage_metadata_job_id)
    comment: Number of unique jobs with usage
    display_name: Active Jobs
    format:
      type: number
      abbreviation: compact
    synonyms:
      - job count
      - jobs
      - workflows
  
  - name: usage_days
    expr: COUNT(DISTINCT source.usage_date)
    comment: Number of days with usage
    display_name: Usage Days
    format:
      type: number
    synonyms:
      - days
      - active days

  - name: usage_records
    expr: COUNT(source.record_id)
    comment: Number of billing records
    display_name: Records
    format:
      type: number
      abbreviation: compact
    synonyms:
      - record count
      - billing records

  # === Tag Coverage Measures ===
  - name: tagged_cost
    expr: SUM(CASE WHEN source.is_tagged = TRUE THEN source.list_cost ELSE 0 END)
    comment: Cost from resources that have custom tags assigned
    display_name: Tagged Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - tagged spend
      - attributed cost
  
  - name: untagged_cost
    expr: SUM(CASE WHEN source.is_tagged = FALSE OR source.is_tagged IS NULL THEN source.list_cost ELSE 0 END)
    comment: Cost from resources without custom tags - needs tagging for proper attribution
    display_name: Untagged Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - unattributed cost
      - cost needing tags
  
  - name: tag_coverage_pct
    expr: (SUM(CASE WHEN source.is_tagged = TRUE THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of cost that has custom tags for attribution
    display_name: Tag Coverage %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - tag coverage
      - tagging rate
      - attribution rate

  # === Serverless vs Classic Cost ===
  - name: serverless_cost
    expr: SUM(CASE WHEN source.product_features_is_serverless THEN source.list_cost ELSE 0 END)
    comment: Total serverless compute cost
    display_name: Serverless Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - serverless spend
  
  - name: classic_compute_cost
    expr: SUM(CASE WHEN NOT source.product_features_is_serverless OR source.product_features_is_serverless IS NULL THEN source.list_cost ELSE 0 END)
    comment: Total classic (non-serverless) compute cost
    display_name: Classic Compute Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - classic spend
      - cluster cost
  
  - name: serverless_ratio
    expr: (SUM(CASE WHEN source.product_features_is_serverless THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of spend on serverless compute
    display_name: Serverless Ratio
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - serverless percentage
      - serverless adoption

  # === Period Comparison Measures (Dashboard Pattern) ===
  - name: last_7_day_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -7) THEN source.list_cost ELSE 0 END)
    comment: Total cost in the last 7 days
    display_name: Last 7 Day Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - this week cost
      - recent week spend
  
  - name: prior_7_day_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -14) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -7) THEN source.list_cost ELSE 0 END)
    comment: Total cost in the 7 days prior to last week
    display_name: Prior 7 Day Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - last week cost
      - previous week spend
  
  - name: week_over_week_growth_pct
    expr: >
      (SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -7) THEN source.list_cost ELSE 0 END) -
       SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -14) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -7) THEN source.list_cost ELSE 0 END)) * 100.0 /
      NULLIF(SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -14) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -7) THEN source.list_cost ELSE 0 END), 0)
    comment: Week-over-week cost growth percentage
    display_name: WoW Growth %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - weekly growth
      - wow change
      - week over week
  
  - name: last_30_day_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -30) THEN source.list_cost ELSE 0 END)
    comment: Total cost in the last 30 days
    display_name: Last 30 Day Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - this month cost
      - recent month spend
  
  - name: prior_30_day_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -60) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -30) THEN source.list_cost ELSE 0 END)
    comment: Total cost in the 30 days prior to last month
    display_name: Prior 30 Day Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - last month cost
      - previous month spend
  
  - name: month_over_month_growth_pct
    expr: >
      (SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -30) THEN source.list_cost ELSE 0 END) -
       SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -60) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -30) THEN source.list_cost ELSE 0 END)) * 100.0 /
      NULLIF(SUM(CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -60) AND source.usage_date < DATE_ADD(CURRENT_DATE(), -30) THEN source.list_cost ELSE 0 END), 0)
    comment: Month-over-month cost growth percentage (30 vs prior 30 days)
    display_name: MoM Growth %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - monthly growth
      - mom change
      - month over month

  # === MTD/YTD Measures ===
  - name: mtd_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_TRUNC('month', CURRENT_DATE()) THEN source.list_cost ELSE 0 END)
    comment: Month-to-date cost (current month only)
    display_name: MTD Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - month to date
      - current month spend
  
  - name: ytd_cost
    expr: SUM(CASE WHEN source.usage_date >= DATE_TRUNC('year', CURRENT_DATE()) THEN source.list_cost ELSE 0 END)
    comment: Year-to-date cost (current year only)
    display_name: YTD Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - year to date
      - annual spend

  # === 30-Day Entity Counts (KPI Pattern) ===
  - name: unique_jobs_30d
    expr: COUNT(DISTINCT CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -30) THEN source.usage_metadata_job_id END)
    comment: Count of unique jobs that incurred cost in last 30 days
    display_name: Active Jobs (30d)
    format:
      type: number
    synonyms:
      - job count 30d
      - recent jobs
  
  - name: unique_users_30d
    expr: COUNT(DISTINCT CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -30) THEN source.identity_metadata_run_as END)
    comment: Count of unique users who ran workloads in last 30 days
    display_name: Active Users (30d)
    format:
      type: number
    synonyms:
      - user count 30d
      - recent users
  
  - name: unique_workspaces_30d
    expr: COUNT(DISTINCT CASE WHEN source.usage_date >= DATE_ADD(CURRENT_DATE(), -30) THEN source.workspace_id END)
    comment: Count of unique workspaces with activity in last 30 days
    display_name: Active Workspaces (30d)
    format:
      type: number
    synonyms:
      - workspace count 30d
      - recent workspaces
