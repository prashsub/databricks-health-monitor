# Metric View: cost_analytics
# Comprehensive FinOps metrics for cost analysis, chargeback, and budget tracking
#
# Source: fact_usage (billing domain)
# Schema validation done against: gold_layer_design/yaml/billing/fact_usage.yaml
#
# Key Business Questions Answered:
#   - What are our top workspaces/SKUs by cost?
#   - Show me costs by custom tags for chargeback
#   - What's our serverless vs classic compute cost split?
#   - Which teams/projects are driving the most cost?
#   - What percentage of costs are properly tagged?

version: "1.1"
comment: >
  Comprehensive cost analytics for FinOps, chargeback, and budget tracking.
  Optimized for Genie natural language queries about Databricks costs.

  DIMENSIONS: Filter and group by workspace, SKU, cloud, region, time (year/quarter/month),
  custom tags (team, project, cost_center, environment), owner, and compute type.

  MEASURES: Total cost, total DBU, serverless vs classic cost, tagged vs untagged cost,
  tag coverage percentage, cost per DBU, active workspaces/users.

  Example queries:
  - "What are our costs by workspace this month?"
  - "Show cost by team tag for chargeback"
  - "What's our serverless cost percentage?"
  - "Which projects have the highest cost?"
  - "What's our tag coverage rate?"

source: ${catalog}.${gold_schema}.fact_usage

joins:
  - name: dim_workspace
    source: ${catalog}.${gold_schema}.dim_workspace
    'on': source.workspace_id = dim_workspace.workspace_id AND dim_workspace.is_current = true

  - name: dim_sku
    source: ${catalog}.${gold_schema}.dim_sku
    'on': source.sku_name = dim_sku.sku_name AND dim_sku.is_current = true

dimensions:
  # === Primary Dimensions ===
  - name: usage_date
    expr: source.usage_date
    comment: Date of DBU consumption for time-based cost analysis and trending
    display_name: Usage Date
    synonyms:
      - date
      - cost date
      - billing date
      - day

  - name: workspace_id
    expr: source.workspace_id
    comment: Workspace identifier for workspace-level cost allocation and filtering
    display_name: Workspace ID
    synonyms:
      - workspace
      - ws id
      - environment id

  - name: workspace_name
    expr: dim_workspace.workspace_name
    comment: Human-readable workspace name for reporting and cost attribution
    display_name: Workspace Name
    synonyms:
      - workspace
      - environment name
      - ws name
      - environment

  - name: sku_name
    expr: source.sku_name
    comment: SKU name indicating product category (JOBS_COMPUTE, SQL_COMPUTE, SERVERLESS, etc.)
    display_name: SKU
    synonyms:
      - sku
      - product
      - compute type
      - service type
      - product type

  # === Cloud & Region Dimensions ===
  - name: cloud_provider
    expr: source.cloud
    comment: Cloud provider (AWS, AZURE, GCP) for cloud-specific cost analysis
    display_name: Cloud
    synonyms:
      - cloud
      - provider
      - cloud platform
      - csp

  - name: region
    expr: dim_workspace.region
    comment: Cloud region where compute ran for regional cost analysis
    display_name: Region
    synonyms:
      - location
      - cloud region
      - data center
      - zone

  # === Time Dimensions (derived from usage_date) ===
  - name: year
    expr: YEAR(source.usage_date)
    comment: Calendar year for annual cost analysis and year-over-year comparisons
    display_name: Year
    synonyms:
      - calendar year
      - fiscal year

  - name: quarter
    expr: QUARTER(source.usage_date)
    comment: Calendar quarter (1-4) for quarterly cost reporting
    display_name: Quarter
    synonyms:
      - q
      - fiscal quarter
      - qtr

  - name: month
    expr: MONTH(source.usage_date)
    comment: Month number (1-12) for monthly cost trending
    display_name: Month
    synonyms:
      - calendar month
      - month number

  - name: week_of_year
    expr: WEEKOFYEAR(source.usage_date)
    comment: Week number (1-52) for weekly cost analysis
    display_name: Week
    synonyms:
      - week
      - week number

  - name: day_of_week
    expr: DAYOFWEEK(source.usage_date)
    comment: Day of week (1=Sunday, 7=Saturday) for weekday vs weekend analysis
    display_name: Day of Week
    synonyms:
      - weekday
      - day number

  # === Tag-Based Dimensions for Chargeback ===
  - name: tag_status
    expr: CASE WHEN source.is_tagged = TRUE THEN 'Tagged' ELSE 'Untagged' END
    comment: Whether the usage record has custom tags for cost attribution
    display_name: Tag Status
    synonyms:
      - tagged
      - has tags
      - tagging status

  - name: team_tag
    expr: COALESCE(source.custom_tags['team'], 'Unassigned')
    comment: Team tag value for chargeback reporting - extracts 'team' key from custom_tags
    display_name: Team
    synonyms:
      - team
      - department
      - business unit
      - team tag
      - bu

  - name: project_tag
    expr: COALESCE(source.custom_tags['project'], 'Unassigned')
    comment: Project tag value for cost allocation - extracts 'project' key from custom_tags
    display_name: Project
    synonyms:
      - project
      - initiative
      - project tag
      - workstream

  - name: cost_center_tag
    expr: COALESCE(source.custom_tags['cost_center'], source.custom_tags['costcenter'], 'Unassigned')
    comment: Cost center tag for financial reporting - extracts 'cost_center' or 'costcenter' key
    display_name: Cost Center
    synonyms:
      - cost center
      - cc
      - cost_center
      - costcenter

  - name: env_tag
    expr: COALESCE(source.custom_tags['env'], source.custom_tags['environment'], 'Unknown')
    comment: Environment tag (dev, staging, prod) - extracts 'env' or 'environment' key
    display_name: Environment
    synonyms:
      - environment
      - env
      - stage
      - tier

  # === Owner/Attribution Dimensions ===
  - name: run_as
    expr: source.identity_metadata_run_as
    comment: User or service principal who ran the workload (for cost attribution)
    display_name: Run As User
    synonyms:
      - owner
      - user
      - run by
      - executed by
      - principal

  - name: created_by
    expr: source.identity_metadata_created_by
    comment: User who created the resource generating this cost
    display_name: Created By
    synonyms:
      - creator
      - resource creator
      - owner

  - name: owned_by
    expr: source.identity_metadata_owned_by
    comment: User who owns the resource generating this cost
    display_name: Owned By
    synonyms:
      - owner
      - resource owner

  # === Compute Type Dimensions ===
  - name: is_serverless
    expr: source.product_features_is_serverless
    comment: Whether usage is from serverless compute (true) or classic (false)
    display_name: Is Serverless
    synonyms:
      - serverless
      - serverless compute

  - name: is_photon
    expr: source.product_features_is_photon
    comment: Whether Photon acceleration was enabled
    display_name: Is Photon
    synonyms:
      - photon
      - photon enabled
      - accelerated

  - name: billing_origin_product
    expr: source.billing_origin_product
    comment: Product that originated the usage (Jobs, SQL, Model Serving, etc.)
    display_name: Billing Product
    synonyms:
      - product
      - origin product
      - source product

  - name: usage_type
    expr: source.usage_type
    comment: Type of usage (COMPUTE_TIME, STORAGE_SPACE, NETWORK_BYTES, etc.)
    display_name: Usage Type
    synonyms:
      - type
      - consumption type
      - resource type

  # === Usage Metadata Dimensions (for drill-down) ===
  - name: job_name
    expr: source.usage_metadata_job_name
    comment: Name of the job generating this cost (if applicable)
    display_name: Job Name
    synonyms:
      - job
      - workflow
      - pipeline

  - name: cluster_id
    expr: source.usage_metadata_cluster_id
    comment: Cluster ID generating this cost (for cluster-level attribution)
    display_name: Cluster ID
    synonyms:
      - cluster
      - compute cluster

  - name: warehouse_id
    expr: source.usage_metadata_warehouse_id
    comment: SQL Warehouse ID generating this cost (for warehouse-level attribution)
    display_name: Warehouse ID
    synonyms:
      - warehouse
      - sql warehouse
      - endpoint

measures:
  # === Primary Cost & Volume Measures ===
  - name: total_dbu
    expr: SUM(source.usage_quantity)
    comment: Total DBU consumption. Primary volume metric for capacity analysis.
    display_name: Total DBU
    format:
      type: number
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - dbu
      - dbu consumption
      - databricks units
      - compute units
      - usage

  - name: total_cost
    expr: SUM(source.list_cost)
    comment: Total estimated cost in USD based on list prices. Primary financial metric.
    display_name: Total Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - cost
      - spend
      - expense
      - dollars
      - amount
      - spending

  - name: avg_daily_cost
    expr: AVG(source.list_cost)
    comment: Average cost per usage record for typical consumption analysis
    display_name: Avg Daily Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - daily average
      - average cost
      - avg cost

  - name: avg_cost_per_dbu
    expr: SUM(source.list_cost) / NULLIF(SUM(source.usage_quantity), 0)
    comment: Average cost per DBU. Useful for pricing analysis and efficiency tracking.
    display_name: Avg Cost per DBU
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 4
    synonyms:
      - unit cost
      - cost per dbu
      - dbu price
      - effective rate

  # === Serverless vs Classic Cost Analysis ===
  - name: serverless_cost
    expr: SUM(CASE WHEN source.product_features_is_serverless = TRUE THEN source.list_cost ELSE 0 END)
    comment: Total cost from serverless compute (SQL Serverless, Jobs Serverless)
    display_name: Serverless Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - serverless spend
      - serverless expense

  - name: classic_cost
    expr: SUM(CASE WHEN source.product_features_is_serverless = FALSE OR source.product_features_is_serverless IS NULL THEN source.list_cost ELSE 0 END)
    comment: Total cost from classic (non-serverless) compute
    display_name: Classic Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - traditional cost
      - non-serverless cost

  - name: serverless_cost_pct
    expr: (SUM(CASE WHEN source.product_features_is_serverless = TRUE THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of total cost from serverless compute
    display_name: Serverless %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - serverless percentage
      - serverless ratio

  # === Tag-Based Cost Attribution (Critical for Chargeback) ===
  - name: tagged_cost
    expr: SUM(CASE WHEN source.is_tagged = TRUE THEN source.list_cost ELSE 0 END)
    comment: Cost from resources with custom tags. Use for chargeback attribution.
    display_name: Tagged Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - tagged spend
      - attributed cost
      - allocated cost

  - name: untagged_cost
    expr: SUM(CASE WHEN source.is_tagged = FALSE THEN source.list_cost ELSE 0 END)
    comment: Cost from resources without custom tags. Needs tagging for proper attribution.
    display_name: Untagged Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - unattributed cost
      - cost needing tags
      - missing tags cost

  - name: tag_coverage_pct
    expr: (SUM(CASE WHEN source.is_tagged = TRUE THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of cost that has custom tags for attribution. Goal is 100%.
    display_name: Tag Coverage %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - tag coverage
      - tagging rate
      - attribution rate
      - tag compliance

  # === Activity & Volume Measures ===
  - name: record_count
    expr: COUNT(source.record_id)
    comment: Number of usage records for volume analysis
    display_name: Records
    format:
      type: number
      abbreviation: compact
    synonyms:
      - count
      - row count
      - usage records

  - name: active_workspaces
    expr: COUNT(DISTINCT source.workspace_id)
    comment: Number of workspaces with usage in this period
    display_name: Active Workspaces
    format:
      type: number
    synonyms:
      - workspace count
      - workspaces
      - environments

  - name: active_users
    expr: COUNT(DISTINCT source.identity_metadata_run_as)
    comment: Number of unique users/principals with usage
    display_name: Active Users
    format:
      type: number
    synonyms:
      - user count
      - users
      - principals

  - name: usage_days
    expr: COUNT(DISTINCT source.usage_date)
    comment: Number of days with usage activity
    display_name: Usage Days
    format:
      type: number
    synonyms:
      - days
      - active days

  - name: unique_skus
    expr: COUNT(DISTINCT source.sku_name)
    comment: Number of different SKUs/products used
    display_name: Unique SKUs
    format:
      type: number
    synonyms:
      - sku count
      - product count

  - name: unique_jobs
    expr: COUNT(DISTINCT source.usage_metadata_job_id)
    comment: Number of unique jobs with usage
    display_name: Unique Jobs
    format:
      type: number
    synonyms:
      - job count
      - workflows

  # === Blog-Derived Measures (Workflow Advisor) ===
  - name: all_purpose_cost
    expr: SUM(CASE WHEN source.sku_name LIKE '%ALL_PURPOSE%' OR source.sku_name LIKE '%INTERACTIVE%' THEN source.list_cost ELSE 0 END)
    comment: Cost from All-Purpose clusters - these are less cost-efficient than Job clusters (from Workflow Advisor blog)
    display_name: All-Purpose Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - interactive cost
      - all purpose spend
      - ad hoc cost

  - name: jobs_cost
    expr: SUM(CASE WHEN source.sku_name LIKE '%JOBS%' AND source.sku_name NOT LIKE '%ALL_PURPOSE%' THEN source.list_cost ELSE 0 END)
    comment: Cost from dedicated Job clusters - more cost-efficient than All-Purpose (from Workflow Advisor blog)
    display_name: Jobs Compute Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - job cluster cost
      - automation cost
      - jobs spend

  - name: all_purpose_cost_pct
    expr: (SUM(CASE WHEN source.sku_name LIKE '%ALL_PURPOSE%' OR source.sku_name LIKE '%INTERACTIVE%' THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of cost from All-Purpose clusters - target is to minimize this (from Workflow Advisor blog)
    display_name: All-Purpose %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - interactive percentage
      - all purpose ratio

  - name: sql_warehouse_cost
    expr: SUM(CASE WHEN source.sku_name LIKE '%SQL%' OR source.sku_name LIKE '%DBSQL%' THEN source.list_cost ELSE 0 END)
    comment: Cost from SQL Warehouses
    display_name: SQL Warehouse Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - dbsql cost
      - sql cost
      - analytics cost

  - name: model_serving_cost
    expr: SUM(CASE WHEN source.sku_name LIKE '%MODEL_SERVING%' OR source.sku_name LIKE '%INFERENCE%' THEN source.list_cost ELSE 0 END)
    comment: Cost from Model Serving endpoints
    display_name: Model Serving Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - inference cost
      - ml serving cost

  - name: photon_cost
    expr: SUM(CASE WHEN source.product_features_is_photon = TRUE THEN source.list_cost ELSE 0 END)
    comment: Cost from Photon-accelerated workloads
    display_name: Photon Cost
    format:
      type: currency
      currency_code: USD
      decimal_places:
        type: exact
        places: 2
      abbreviation: compact
    synonyms:
      - accelerated cost
      - photon spend

  - name: photon_cost_pct
    expr: (SUM(CASE WHEN source.product_features_is_photon = TRUE THEN source.list_cost ELSE 0 END) * 100.0) / NULLIF(SUM(source.list_cost), 0)
    comment: Percentage of cost using Photon acceleration
    display_name: Photon %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 1
    synonyms:
      - photon percentage
      - accelerated ratio
