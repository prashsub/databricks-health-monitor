"""
ML Prediction Table Metadata
============================

Centralized metadata definitions for all ML prediction/inference tables.
Used to add table and column descriptions after table creation.

This enables:
- Genie Space natural language queries
- AI/BI dashboard auto-complete
- Data catalog discoverability
- LLM-friendly documentation
"""

from typing import Dict, Any

# ==============================================================================
# PREDICTION TABLE METADATA REGISTRY
# ==============================================================================

PREDICTION_TABLE_METADATA: Dict[str, Dict[str, Any]] = {
    # =========================================================================
    # COST DOMAIN
    # =========================================================================
    "cost_anomaly_predictions": {
        "table_comment": """ML predictions from cost_anomaly_detector model. 
        Identifies unusual cost patterns using Isolation Forest anomaly detection. 
        Prediction value -1 indicates anomaly, 1 indicates normal. 
        Use for proactive cost monitoring and alerting on unexpected spend patterns.
        Source: cost_features | Model: Isolation Forest | Domain: Cost""",
        "columns": {
            "workspace_id": "Workspace identifier for cost attribution. Join with dim_workspace for workspace details.",
            "usage_date": "Date of the cost observation being scored for anomalies.",
            "prediction": "Anomaly indicator: -1 = anomaly detected, 1 = normal cost pattern.",
            "model_name": "ML model that generated this prediction (cost_anomaly_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "budget_forecast_predictions": {
        "table_comment": """ML predictions from budget_forecaster model.
        Forecasts expected costs using gradient boosting regression on historical patterns.
        Use for budget planning, capacity planning, and cost trend analysis.
        Source: cost_features | Model: GradientBoostingRegressor | Domain: Cost""",
        "columns": {
            "workspace_id": "Workspace identifier for budget allocation.",
            "usage_date": "Date for which budget is being forecasted.",
            "prediction": "Predicted cost value in USD. Compare against actual for variance analysis.",
            "model_name": "ML model that generated this prediction (budget_forecaster).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "job_cost_optimizer_predictions": {
        "table_comment": """ML predictions from job_cost_optimizer model.
        Identifies jobs with cost optimization opportunities using gradient boosting.
        Higher prediction scores indicate greater savings potential.
        Source: cost_features | Model: GradientBoostingRegressor | Domain: Cost""",
        "columns": {
            "workspace_id": "Workspace containing jobs to optimize.",
            "usage_date": "Date of the cost data used for optimization analysis.",
            "prediction": "Optimization potential score (0-1). Higher = more savings opportunity.",
            "model_name": "ML model that generated this prediction (job_cost_optimizer).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "chargeback_predictions": {
        "table_comment": """ML predictions from chargeback_attribution model.
        Attributes costs to business units using gradient boosting regression.
        Use for cost allocation, showback reporting, and departmental billing.
        Source: cost_features | Model: GradientBoostingRegressor | Domain: Cost""",
        "columns": {
            "workspace_id": "Workspace for cost attribution.",
            "usage_date": "Date of the cost being attributed.",
            "prediction": "Attributed cost amount in USD for chargeback purposes.",
            "model_name": "ML model that generated this prediction (chargeback_attribution).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "commitment_recommendations": {
        "table_comment": """ML predictions from commitment_recommender model.
        Recommends capacity commitment levels (1=high serverless adoption recommended).
        Use for commit planning and serverless migration decisions.
        Source: cost_features | Model: XGBClassifier | Domain: Cost""",
        "columns": {
            "workspace_id": "Workspace for commitment recommendation.",
            "usage_date": "Date of usage pattern analyzed.",
            "prediction": "Binary recommendation: 1 = high serverless adoption recommended, 0 = maintain current.",
            "model_name": "ML model that generated this prediction (commitment_recommender).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "tag_recommendations": {
        "table_comment": """ML predictions from tag_recommender model.
        Recommends tags for untagged jobs using TF-IDF text analysis and Random Forest classification.
        Use for improving cost attribution coverage and governance compliance.
        Source: cost_features + job names (TF-IDF) | Model: RandomForestClassifier | Domain: Cost""",
        "columns": {
            "job_id": "Unique identifier of the untagged job receiving a tag recommendation.",
            "job_name": "Name of the job (used for TF-IDF text feature extraction).",
            "workspace_id": "Workspace where the job is defined.",
            "usage_date": "Reference date for cost features used in prediction.",
            "predicted_tag": "Recommended tag value (e.g., team name, project, cost center).",
            "confidence_score": "Model confidence in the recommendation (0-1). Higher = more confident.",
            "total_cost_30d": "Total cost associated with this job over 30 days for prioritization.",
            "model_name": "ML model that generated this prediction (tag_recommender).",
            "model_version": "Version of the model used for scoring.",
            "scored_at": "Timestamp when the prediction was generated.",
            "scored_date": "Date partition for efficient querying of recent predictions."
        }
    },
    
    # =========================================================================
    # SECURITY DOMAIN
    # =========================================================================
    "security_threat_predictions": {
        "table_comment": """ML predictions from security_threat_detector model.
        Identifies potential security threats using Isolation Forest anomaly detection.
        Prediction -1 indicates potential threat, 1 indicates normal behavior.
        Source: security_features | Model: Isolation Forest | Domain: Security""",
        "columns": {
            "user_id": "User identifier being monitored for security threats.",
            "event_date": "Date of the security activity being analyzed.",
            "prediction": "Threat indicator: -1 = potential threat detected, 1 = normal activity.",
            "model_name": "ML model that generated this prediction (security_threat_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "exfiltration_predictions": {
        "table_comment": """ML predictions from exfiltration_detector model.
        Identifies potential data exfiltration patterns using Isolation Forest.
        Prediction -1 indicates potential exfiltration risk, 1 indicates normal behavior.
        Source: security_features | Model: Isolation Forest | Domain: Security""",
        "columns": {
            "user_id": "User identifier being monitored for data exfiltration.",
            "event_date": "Date of the activity being analyzed for exfiltration patterns.",
            "prediction": "Exfiltration risk: -1 = potential risk detected, 1 = normal activity.",
            "model_name": "ML model that generated this prediction (exfiltration_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "privilege_escalation_predictions": {
        "table_comment": """ML predictions from privilege_escalation_detector model.
        Identifies abnormal privilege usage patterns using Isolation Forest.
        Prediction -1 indicates potential privilege escalation, 1 indicates normal.
        Source: security_features | Model: Isolation Forest | Domain: Security""",
        "columns": {
            "user_id": "User identifier being monitored for privilege escalation.",
            "event_date": "Date of the privilege activity being analyzed.",
            "prediction": "Escalation indicator: -1 = potential escalation, 1 = normal usage.",
            "model_name": "ML model that generated this prediction (privilege_escalation_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "user_behavior_predictions": {
        "table_comment": """ML predictions from user_behavior_baseline model.
        Establishes user behavior baselines and detects deviations using Isolation Forest.
        Prediction -1 indicates anomalous behavior, 1 indicates baseline activity.
        Source: security_features | Model: Isolation Forest | Domain: Security""",
        "columns": {
            "user_id": "User identifier for behavior baseline analysis.",
            "event_date": "Date of the user activity being compared against baseline.",
            "prediction": "Behavior indicator: -1 = anomalous behavior, 1 = within baseline.",
            "model_name": "ML model that generated this prediction (user_behavior_baseline).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    # =========================================================================
    # PERFORMANCE DOMAIN
    # =========================================================================
    "query_performance_predictions": {
        "table_comment": """ML predictions from query_performance_forecaster model.
        Forecasts query execution times using gradient boosting regression.
        Use for SLA planning, capacity management, and performance optimization.
        Source: performance_features | Model: GradientBoostingRegressor | Domain: Performance""",
        "columns": {
            "warehouse_id": "SQL Warehouse identifier for performance analysis.",
            "query_date": "Date for which query performance is being forecasted.",
            "prediction": "Predicted query execution time in seconds.",
            "model_name": "ML model that generated this prediction (query_performance_forecaster).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "warehouse_optimizer_predictions": {
        "table_comment": """ML predictions from warehouse_optimizer model.
        Recommends warehouse sizing and configuration optimizations.
        Use for right-sizing warehouses and improving cost efficiency.
        Source: performance_features | Model: GradientBoostingRegressor | Domain: Performance""",
        "columns": {
            "warehouse_id": "SQL Warehouse identifier for optimization recommendation.",
            "query_date": "Date of performance data used for optimization analysis.",
            "prediction": "Optimization recommendation score. Higher = more optimization needed.",
            "model_name": "ML model that generated this prediction (warehouse_optimizer).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "cluster_capacity_predictions": {
        "table_comment": """ML predictions from cluster_capacity_planner model.
        Forecasts cluster capacity needs using gradient boosting regression.
        Use for capacity planning and auto-scaling policy optimization.
        Source: performance_features | Model: GradientBoostingRegressor | Domain: Performance""",
        "columns": {
            "warehouse_id": "Warehouse identifier for capacity planning.",
            "query_date": "Date for which capacity is being forecasted.",
            "prediction": "Predicted capacity requirement (cluster count or DBU).",
            "model_name": "ML model that generated this prediction (cluster_capacity_planner).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "performance_regression_predictions": {
        "table_comment": """ML predictions from performance_regression_detector model.
        Identifies performance degradation patterns using Isolation Forest.
        Prediction -1 indicates performance regression, 1 indicates normal performance.
        Source: performance_features | Model: Isolation Forest | Domain: Performance""",
        "columns": {
            "warehouse_id": "SQL Warehouse identifier for regression detection.",
            "query_date": "Date of performance being analyzed for regressions.",
            "prediction": "Regression indicator: -1 = regression detected, 1 = normal performance.",
            "model_name": "ML model that generated this prediction (performance_regression_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "dbr_migration_predictions": {
        "table_comment": """ML predictions from dbr_migration_risk_scorer model.
        Assesses risk of DBR version migration using Random Forest classification.
        Use for planning runtime upgrades and identifying high-risk migrations.
        Source: reliability_features | Model: RandomForestClassifier | Domain: Performance""",
        "columns": {
            "job_id": "Job identifier for migration risk assessment.",
            "run_date": "Date of job run data used for risk analysis.",
            "prediction": "Migration risk: 1 = high risk, 0 = low risk.",
            "model_name": "ML model that generated this prediction (dbr_migration_risk_scorer).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "cache_hit_predictions": {
        "table_comment": """ML predictions from cache_hit_predictor model.
        Predicts query cache hit likelihood using XGBoost classification.
        Use for cache optimization and query planning.
        Source: performance_features | Model: XGBClassifier | Domain: Performance""",
        "columns": {
            "warehouse_id": "SQL Warehouse identifier for cache analysis.",
            "query_date": "Date of performance data used for cache prediction.",
            "prediction": "Binary prediction: 1 = likely cache hit, 0 = likely cache miss.",
            "model_name": "ML model that generated this prediction (cache_hit_predictor).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "query_optimization_predictions": {
        "table_comment": """ML predictions from query_optimization_recommender model.
        Identifies queries needing optimization using XGBoost classification.
        Use for query tuning prioritization and performance improvement.
        Source: performance_features | Model: XGBClassifier | Domain: Performance""",
        "columns": {
            "warehouse_id": "SQL Warehouse identifier for optimization targeting.",
            "query_date": "Date of query performance data analyzed.",
            "prediction": "Binary prediction: 1 = needs optimization, 0 = performing well.",
            "model_name": "ML model that generated this prediction (query_optimization_recommender).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    # =========================================================================
    # RELIABILITY DOMAIN
    # =========================================================================
    "job_failure_predictions": {
        "table_comment": """ML predictions from job_failure_predictor model.
        Predicts job failure likelihood using XGBoost classification.
        Use for proactive monitoring and failure prevention.
        Source: reliability_features | Model: XGBClassifier | Domain: Reliability""",
        "columns": {
            "job_id": "Job identifier for failure prediction.",
            "run_date": "Date for which failure likelihood is being predicted.",
            "prediction": "Binary prediction: 1 = high failure likelihood, 0 = likely to succeed.",
            "model_name": "ML model that generated this prediction (job_failure_predictor).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "duration_predictions": {
        "table_comment": """ML predictions from job_duration_forecaster model.
        Forecasts job run duration using gradient boosting regression.
        Use for SLA planning, scheduling optimization, and capacity management.
        Source: reliability_features | Model: GradientBoostingRegressor | Domain: Reliability""",
        "columns": {
            "job_id": "Job identifier for duration forecasting.",
            "run_date": "Date for which job duration is being forecasted.",
            "prediction": "Predicted job duration in seconds.",
            "model_name": "ML model that generated this prediction (job_duration_forecaster).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "sla_breach_predictions": {
        "table_comment": """ML predictions from sla_breach_predictor model.
        Predicts SLA breach likelihood using XGBoost classification.
        Use for SLA monitoring and proactive intervention.
        Source: reliability_features | Model: XGBClassifier | Domain: Reliability""",
        "columns": {
            "job_id": "Job identifier for SLA risk assessment.",
            "run_date": "Date for which SLA breach risk is being predicted.",
            "prediction": "Binary prediction: 1 = high SLA breach risk, 0 = likely to meet SLA.",
            "model_name": "ML model that generated this prediction (sla_breach_predictor).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "retry_success_predictions": {
        "table_comment": """ML predictions from retry_success_predictor model.
        Predicts retry success likelihood using XGBoost classification.
        Use for intelligent retry policies and failure handling optimization.
        Source: reliability_features | Model: XGBClassifier | Domain: Reliability""",
        "columns": {
            "job_id": "Job identifier for retry analysis.",
            "run_date": "Date of job run data used for retry prediction.",
            "prediction": "Binary prediction: 1 = retry likely to succeed, 0 = retry unlikely to help.",
            "model_name": "ML model that generated this prediction (retry_success_predictor).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "pipeline_health_predictions": {
        "table_comment": """ML predictions from pipeline_health_scorer model.
        Scores overall pipeline health using gradient boosting regression.
        Use for pipeline monitoring and prioritizing maintenance efforts.
        Source: reliability_features | Model: GradientBoostingRegressor | Domain: Reliability""",
        "columns": {
            "job_id": "Job/pipeline identifier for health scoring.",
            "run_date": "Date of pipeline activity being scored.",
            "prediction": "Health score (0-1). Higher = healthier pipeline.",
            "model_name": "ML model that generated this prediction (pipeline_health_scorer).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    # =========================================================================
    # QUALITY DOMAIN
    # =========================================================================
    "data_drift_predictions": {
        "table_comment": """ML predictions from data_drift_detector model.
        Detects data distribution drift using Isolation Forest anomaly detection.
        Prediction -1 indicates drift detected, 1 indicates stable distribution.
        Source: quality_features | Model: Isolation Forest | Domain: Quality""",
        "columns": {
            "catalog_name": "Unity Catalog name being monitored for data drift.",
            "snapshot_date": "Date of the data quality snapshot being analyzed.",
            "prediction": "Drift indicator: -1 = drift detected, 1 = distribution stable.",
            "model_name": "ML model that generated this prediction (data_drift_detector).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    },
    
    "freshness_predictions": {
        "table_comment": """ML predictions from data_freshness_predictor model.
        Predicts data freshness issues using gradient boosting regression.
        Use for monitoring data pipeline timeliness and SLA compliance.
        Source: quality_features | Model: GradientBoostingRegressor | Domain: Quality""",
        "columns": {
            "catalog_name": "Unity Catalog name being monitored for freshness.",
            "snapshot_date": "Date of the data quality snapshot being analyzed.",
            "prediction": "Freshness score or predicted staleness. Higher = fresher data.",
            "model_name": "ML model that generated this prediction (data_freshness_predictor).",
            "scored_at": "Timestamp when the prediction was generated by batch inference."
        }
    }
}


# ==============================================================================
# UTILITY FUNCTIONS
# ==============================================================================

def apply_table_metadata(spark, full_table_name: str) -> bool:
    """
    Apply table and column metadata to a prediction table.
    
    Args:
        spark: SparkSession
        full_table_name: Fully qualified table name (catalog.schema.table)
        
    Returns:
        True if metadata was applied successfully, False otherwise
    """
    # Extract table name from fully qualified name
    table_name = full_table_name.split('.')[-1]
    
    if table_name not in PREDICTION_TABLE_METADATA:
        print(f"    âš  No metadata defined for {table_name}")
        return False
    
    metadata = PREDICTION_TABLE_METADATA[table_name]
    
    try:
        # Apply table comment
        table_comment = metadata.get("table_comment", "").replace("'", "''")
        spark.sql(f"COMMENT ON TABLE {full_table_name} IS '{table_comment}'")
        print(f"    ðŸ“ Table comment added")
        
        # Apply column comments
        columns = metadata.get("columns", {})
        columns_updated = 0
        
        # Get actual columns from table
        table_columns = [f.name for f in spark.table(full_table_name).schema.fields]
        
        for col_name, col_comment in columns.items():
            if col_name in table_columns:
                escaped_comment = col_comment.replace("'", "''")
                spark.sql(f"ALTER TABLE {full_table_name} ALTER COLUMN `{col_name}` COMMENT '{escaped_comment}'")
                columns_updated += 1
        
        print(f"    ðŸ“ {columns_updated}/{len(columns)} column comments added")
        return True
        
    except Exception as e:
        print(f"    âš  Metadata error: {str(e)[:100]}")
        return False


def get_table_metadata(table_name: str) -> Dict[str, Any]:
    """
    Get metadata for a specific prediction table.
    
    Args:
        table_name: Short table name (e.g., 'cost_anomaly_predictions')
        
    Returns:
        Dictionary with table_comment and columns metadata
    """
    return PREDICTION_TABLE_METADATA.get(table_name, {})


def get_all_prediction_tables() -> list:
    """Get list of all prediction table names with metadata defined."""
    return list(PREDICTION_TABLE_METADATA.keys())



