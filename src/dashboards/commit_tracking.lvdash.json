{
  "displayName": "Commit Tracking & Forecast Dashboard",
  "warehouse_id": "${warehouse_id}",
  "pages": [
    {
      "name": "page_commit_overview",
      "displayName": "Commit vs Consumption",
      "layout": [
        {
          "widget": {
            "name": "param_annual_commit",
            "queries": [
              {
                "name": "param_query",
                "query": {
                  "datasetName": "ds_commit_options",
                  "parameters": [
                    {
                      "name": "annual_commit",
                      "keyword": "annual_commit"
                    }
                  ],
                  "disaggregated": false
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "filter-single-select",
              "encodings": {
                "fields": [
                  {
                    "displayName": "Annual Commit ($)",
                    "fieldName": "commit_amount",
                    "queryName": "options_query"
                  },
                  {
                    "parameterName": "annual_commit",
                    "queryName": "param_query"
                  }
                ]
              },
              "selection": {
                "defaultSelection": {
                  "values": {
                    "dataType": "DECIMAL",
                    "values": [
                      {
                        "value": "1000000"
                      }
                    ]
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Annual Commit ($)",
                "description": "Enter your annual commit amount"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 0,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "kpi_ytd_spend",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_ytd_spend",
                  "fields": [
                    {
                      "name": "ytd_spend",
                      "expression": "`ytd_spend`"
                    }
                  ],
                  "disaggregated": false
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {
                "value": {
                  "fieldName": "ytd_spend",
                  "displayName": "YTD Spend",
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact",
                    "decimalPlaces": {
                      "type": "max",
                      "places": 0
                    }
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "YTD Consumption",
                "description": "Year-to-date actual spend"
              }
            }
          },
          "position": {
            "x": 2,
            "y": 0,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "kpi_commit_utilization",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_commit_status",
                  "fields": [
                    {
                      "name": "utilization_pct",
                      "expression": "`utilization_pct`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {
                "value": {
                  "fieldName": "utilization_pct",
                  "displayName": "Utilization %"
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Commit Utilization",
                "description": "% of annual commit consumed"
              }
            }
          },
          "position": {
            "x": 4,
            "y": 0,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "kpi_forecasted_annual",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_forecast_summary",
                  "fields": [
                    {
                      "name": "forecasted_annual",
                      "expression": "`forecasted_annual`"
                    }
                  ],
                  "disaggregated": false
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {
                "value": {
                  "fieldName": "forecasted_annual",
                  "displayName": "Forecasted Annual",
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact",
                    "decimalPlaces": {
                      "type": "max",
                      "places": 0
                    }
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Forecasted Annual",
                "description": "Projected year-end spend"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 2,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "kpi_projected_variance",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_variance",
                  "fields": [
                    {
                      "name": "projected_variance",
                      "expression": "`projected_variance`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {
                "value": {
                  "fieldName": "projected_variance",
                  "displayName": "Projected Variance",
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact",
                    "decimalPlaces": {
                      "type": "max",
                      "places": 0
                    }
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Projected Variance",
                "description": "Overspend (+) / Underspend (-)"
              }
            }
          },
          "position": {
            "x": 2,
            "y": 2,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "kpi_run_rate",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_run_rate",
                  "fields": [
                    {
                      "name": "daily_run_rate",
                      "expression": "`daily_run_rate`"
                    }
                  ],
                  "disaggregated": false
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {
                "value": {
                  "fieldName": "daily_run_rate",
                  "displayName": "Run Rate",
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact",
                    "decimalPlaces": {
                      "type": "max",
                      "places": 0
                    }
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Run Rate",
                "description": "Current daily spend rate"
              }
            }
          },
          "position": {
            "x": 4,
            "y": 2,
            "width": 2,
            "height": 2
          }
        },
        {
          "widget": {
            "name": "chart_usage_vs_forecast",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_usage_forecast",
                  "fields": [
                    {
                      "name": "usage_date",
                      "expression": "`usage_date`"
                    },
                    {
                      "name": "daily_cost",
                      "expression": "`daily_cost`"
                    },
                    {
                      "name": "forecast_type",
                      "expression": "`forecast_type`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "area",
              "encodings": {
                "x": {
                  "fieldName": "usage_date",
                  "displayName": "Date",
                  "scale": {
                    "type": "temporal"
                  }
                },
                "y": {
                  "fieldName": "daily_cost",
                  "displayName": "Usage ($)",
                  "scale": {
                    "type": "quantitative"
                  },
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact"
                  }
                },
                "color": {
                  "fieldName": "forecast_type",
                  "displayName": "Type",
                  "scale": {
                    "type": "categorical"
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Total Usage Over Time",
                "description": "Actuals vs AI Forecast"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 4,
            "width": 6,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "chart_cumulative_vs_commit",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_cumulative_vs_commit",
                  "fields": [
                    {
                      "name": "usage_date",
                      "expression": "`usage_date`"
                    },
                    {
                      "name": "cumulative_spend",
                      "expression": "`cumulative_spend`"
                    },
                    {
                      "name": "target_line",
                      "expression": "`target_line`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "line",
              "encodings": {
                "x": {
                  "fieldName": "usage_date",
                  "displayName": "Date",
                  "scale": {
                    "type": "temporal"
                  }
                },
                "y": {
                  "fieldName": "cumulative_spend",
                  "displayName": "Cumulative ($)",
                  "scale": {
                    "type": "quantitative"
                  },
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact"
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Cumulative Spend vs Commit Target",
                "description": "Are you on track to hit your commit?"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 10,
            "width": 3,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "chart_monthly_breakdown",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_monthly_breakdown",
                  "fields": [
                    {
                      "name": "month_name",
                      "expression": "`month_name`"
                    },
                    {
                      "name": "monthly_cost",
                      "expression": "`monthly_cost`"
                    },
                    {
                      "name": "monthly_target",
                      "expression": "`monthly_target`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "bar",
              "encodings": {
                "x": {
                  "fieldName": "month_name",
                  "displayName": "Month",
                  "scale": {
                    "type": "ordinal"
                  }
                },
                "y": {
                  "fieldName": "monthly_cost",
                  "displayName": "Spend ($)",
                  "scale": {
                    "type": "quantitative"
                  },
                  "format": {
                    "type": "number-currency",
                    "currencyCode": "USD",
                    "abbreviation": "compact"
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "Monthly Spend vs Target",
                "description": "Bars show actual spend"
              }
            }
          },
          "position": {
            "x": 3,
            "y": 10,
            "width": 3,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "table_monthly_detail",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_monthly_detail",
                  "fields": [
                    {
                      "name": "month_name",
                      "expression": "`month_name`"
                    },
                    {
                      "name": "monthly_cost",
                      "expression": "`monthly_cost`"
                    },
                    {
                      "name": "monthly_target",
                      "expression": "`monthly_target`"
                    },
                    {
                      "name": "variance",
                      "expression": "`variance`"
                    },
                    {
                      "name": "variance_pct",
                      "expression": "`variance_pct`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "table",
              "frame": {
                "showTitle": true,
                "title": "Monthly Spend Detail"
              },
              "encodings": {
                "columns": [
                  {
                    "fieldName": "month_name",
                    "title": "Month",
                    "type": "string"
                  },
                  {
                    "fieldName": "monthly_cost",
                    "title": "Actual ($)",
                    "type": "number"
                  },
                  {
                    "fieldName": "monthly_target",
                    "title": "Target ($)",
                    "type": "number"
                  },
                  {
                    "fieldName": "variance",
                    "title": "Variance ($)",
                    "type": "number"
                  },
                  {
                    "fieldName": "variance_pct",
                    "title": "Variance %",
                    "type": "string"
                  }
                ]
              }
            }
          },
          "position": {
            "x": 0,
            "y": 16,
            "width": 6,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "chart_ml_budget_forecast",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_ml_budget_forecast",
                  "fields": [
                    {
                      "name": "prediction_date",
                      "expression": "`prediction_date`"
                    },
                    {
                      "name": "predicted_daily_cost",
                      "expression": "`predicted_daily_cost`"
                    },
                    {
                      "name": "predicted_cumulative",
                      "expression": "`predicted_cumulative`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "line",
              "encodings": {
                "x": {
                  "fieldName": "prediction_date",
                  "displayName": "Date",
                  "scale": {
                    "type": "temporal"
                  }
                },
                "y": {
                  "fieldName": "predicted_cumulative",
                  "displayName": "Cumulative Forecast ($)",
                  "scale": {
                    "type": "quantitative"
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "\ud83e\udd16 ML: Budget Forecast (Next 30 Days)",
                "description": "From budget_forecaster model"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 22,
            "width": 3,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "table_ml_commitment_rec",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_ml_commitment_rec",
                  "fields": [
                    {
                      "name": "recommendation_type",
                      "expression": "`recommendation_type`"
                    },
                    {
                      "name": "recommended_amount",
                      "expression": "`recommended_amount`"
                    },
                    {
                      "name": "confidence",
                      "expression": "`confidence`"
                    },
                    {
                      "name": "annual_savings",
                      "expression": "`annual_savings`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 2,
              "widgetType": "table",
              "encodings": {
                "columns": [
                  {
                    "fieldName": "recommendation_type",
                    "title": "Recommendation",
                    "type": "string"
                  },
                  {
                    "fieldName": "recommended_amount",
                    "title": "Amount ($)",
                    "type": "number"
                  },
                  {
                    "fieldName": "confidence",
                    "title": "Confidence",
                    "type": "number"
                  },
                  {
                    "fieldName": "annual_savings",
                    "title": "Est. Savings ($)",
                    "type": "number"
                  }
                ]
              },
              "frame": {
                "showTitle": true,
                "title": "\ud83e\udd16 ML: Commitment Recommendations",
                "description": "From commitment_recommender model"
              }
            }
          },
          "position": {
            "x": 3,
            "y": 22,
            "width": 3,
            "height": 6
          }
        },
        {
          "widget": {
            "name": "chart_monitor_cost_trend",
            "queries": [
              {
                "name": "main_query",
                "query": {
                  "datasetName": "ds_monitor_cost_trend",
                  "fields": [
                    {
                      "name": "window_start",
                      "expression": "`window_start`"
                    },
                    {
                      "name": "total_cost",
                      "expression": "`total_cost`"
                    },
                    {
                      "name": "cost_per_dbu",
                      "expression": "`cost_per_dbu`"
                    }
                  ],
                  "disaggregated": true
                }
              }
            ],
            "spec": {
              "version": 3,
              "widgetType": "line",
              "encodings": {
                "x": {
                  "fieldName": "window_start",
                  "displayName": "Date",
                  "scale": {
                    "type": "temporal"
                  }
                },
                "y": {
                  "fieldName": "total_cost",
                  "displayName": "Total Cost ($)",
                  "scale": {
                    "type": "quantitative"
                  }
                }
              },
              "frame": {
                "showTitle": true,
                "title": "\ud83d\udcca Lakehouse Monitor: Daily Cost Trend",
                "description": "Custom metric from fact_usage monitor"
              }
            }
          },
          "position": {
            "x": 0,
            "y": 28,
            "width": 6,
            "height": 6
          }
        }
      ]
    }
  ],
  "datasets": [
    {
      "name": "ds_commit_options",
      "displayName": "Commit Amount Options",
      "query": "SELECT EXPLODE(ARRAY(500000, 1000000, 2000000, 5000000, 10000000)) AS commit_amount",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_ytd_spend",
      "displayName": "YTD Spend",
      "query": "SELECT SUM(list_cost) AS ytd_spend FROM ${catalog}.${gold_schema}.fact_usage WHERE YEAR(usage_date) = YEAR(CURRENT_DATE())"
    },
    {
      "name": "ds_commit_status",
      "displayName": "Commit Status",
      "query": "WITH ytd AS (SELECT SUM(list_cost) AS total FROM ${catalog}.${gold_schema}.fact_usage WHERE YEAR(usage_date) = YEAR(CURRENT_DATE())) SELECT CONCAT(ROUND(ytd.total * 100.0 / NULLIF(:annual_commit, 0), 1), '%') AS utilization_pct FROM ytd",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_forecast_summary",
      "displayName": "Forecast Summary",
      "query": "WITH daily AS (SELECT usage_date, SUM(list_cost) AS daily_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 90 DAYS GROUP BY usage_date), forecast AS (SELECT AVG(daily_cost) * 365 AS forecasted_annual FROM daily) SELECT forecasted_annual FROM forecast"
    },
    {
      "name": "ds_variance",
      "displayName": "Projected Variance",
      "query": "WITH forecast AS (SELECT AVG(daily_cost) * 365 AS forecasted_annual FROM (SELECT usage_date, SUM(list_cost) AS daily_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 90 DAYS GROUP BY usage_date)) SELECT forecast.forecasted_annual - :annual_commit AS projected_variance FROM forecast",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_run_rate",
      "displayName": "Run Rate",
      "query": "SELECT AVG(daily_cost) AS daily_run_rate FROM (SELECT usage_date, SUM(list_cost) AS daily_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS GROUP BY usage_date)"
    },
    {
      "name": "ds_usage_forecast",
      "displayName": "Usage vs Forecast",
      "query": "WITH actuals AS (SELECT usage_date, SUM(list_cost) AS daily_cost, 'Actuals' AS forecast_type FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 90 DAYS GROUP BY usage_date), avg_daily AS (SELECT AVG(daily_cost) AS avg_cost FROM actuals), future AS (SELECT DATEADD(DAY, seq, CURRENT_DATE()) AS usage_date, avg_cost AS daily_cost, 'Forecast' AS forecast_type FROM avg_daily CROSS JOIN (SELECT EXPLODE(SEQUENCE(1, 30)) AS seq)) SELECT * FROM actuals UNION ALL SELECT * FROM future ORDER BY usage_date"
    },
    {
      "name": "ds_cumulative_vs_commit",
      "displayName": "Cumulative vs Commit",
      "query": "WITH daily AS (SELECT usage_date, SUM(list_cost) AS daily_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE YEAR(usage_date) = YEAR(CURRENT_DATE()) GROUP BY usage_date), cumulative AS (SELECT usage_date, SUM(daily_cost) OVER (ORDER BY usage_date) AS cumulative_spend FROM daily) SELECT c.usage_date, c.cumulative_spend, (:annual_commit * DAYOFYEAR(c.usage_date) / 365.0) AS target_line FROM cumulative c ORDER BY c.usage_date",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_monthly_breakdown",
      "displayName": "Monthly Breakdown",
      "query": "WITH monthly AS (SELECT DATE_FORMAT(DATE_TRUNC('month', usage_date), 'MMM') AS month_name, DATE_TRUNC('month', usage_date) AS month_start, SUM(list_cost) AS monthly_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE YEAR(usage_date) = YEAR(CURRENT_DATE()) GROUP BY DATE_FORMAT(DATE_TRUNC('month', usage_date), 'MMM'), DATE_TRUNC('month', usage_date)) SELECT m.month_name, ROUND(m.monthly_cost, 2) AS monthly_cost, ROUND(:annual_commit / 12, 2) AS monthly_target FROM monthly m ORDER BY m.month_start",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_monthly_detail",
      "displayName": "Monthly Detail",
      "query": "WITH monthly AS (SELECT DATE_FORMAT(DATE_TRUNC('month', usage_date), 'MMM yyyy') AS month_name, DATE_TRUNC('month', usage_date) AS month_start, SUM(list_cost) AS monthly_cost FROM ${catalog}.${gold_schema}.fact_usage WHERE YEAR(usage_date) = YEAR(CURRENT_DATE()) GROUP BY DATE_FORMAT(DATE_TRUNC('month', usage_date), 'MMM yyyy'), DATE_TRUNC('month', usage_date)) SELECT m.month_name, ROUND(m.monthly_cost, 2) AS monthly_cost, ROUND(:annual_commit / 12, 2) AS monthly_target, ROUND(m.monthly_cost - (:annual_commit / 12), 2) AS variance, CONCAT(ROUND((m.monthly_cost - (:annual_commit / 12)) * 100.0 / NULLIF((:annual_commit / 12), 0), 1), '%') AS variance_pct FROM monthly m ORDER BY m.month_start",
      "parameters": [
        {
          "displayName": "Annual Commit",
          "keyword": "annual_commit",
          "dataType": "DECIMAL",
          "defaultSelection": {
            "values": {
              "dataType": "DECIMAL",
              "values": [
                {
                  "value": "1000000"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "ds_ml_budget_forecast",
      "displayName": "ML: Budget Forecast (Preview)",
      "query": "SELECT CURRENT_DATE() AS prediction_date, 0.0 AS predicted_daily_cost, 0.0 AS predicted_cumulative LIMIT 1"
    },
    {
      "name": "ds_ml_commitment_rec",
      "displayName": "ML: Commitment Recommendations (Preview)",
      "query": "SELECT 'ML models not yet deployed' AS recommendation_type, 0.0 AS recommended_amount, 0.0 AS confidence, 0.0 AS annual_savings LIMIT 1"
    },
    {
      "name": "ds_monitor_cost_trend",
      "displayName": "Lakehouse: Cost Trend (Preview)",
      "query": "SELECT CURRENT_DATE() AS window_start, 0.0 AS total_cost, 0.0 AS cost_per_dbu LIMIT 1"
    }
  ]
}