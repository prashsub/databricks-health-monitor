{
  "displayName": "Table Health Advisor Dashboard",
  "warehouse_id": "${warehouse_id}",
  "pages": [
    {
      "name": "page_table_health",
      "displayName": "Table Health Overview",
      "layout": [
        {
          "widget": {
            "name": "kpi_total_size",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_summary", "fields": [{"name": "total_size_gb", "expression": "`total_size_gb`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "total_size_gb"}},
              "frame": {"showTitle": true, "title": "Total Storage (GB)", "description": "Total table storage size"}
            }
          },
          "position": {"x": 0, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "kpi_table_count",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_summary", "fields": [{"name": "table_count", "expression": "`table_count`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "table_count"}},
              "frame": {"showTitle": true, "title": "Total Tables", "description": "Managed table count"}
            }
          },
          "position": {"x": 2, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "kpi_needs_optimization",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_optimization_needed", "fields": [{"name": "count", "expression": "`count`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "count"}},
              "frame": {"showTitle": true, "title": "Need Optimization", "description": "Tables needing compaction"}
            }
          },
          "position": {"x": 4, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "chart_size_distribution",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_size_buckets", "fields": [{"name": "size_bucket", "expression": "`size_bucket`"}, {"name": "table_count", "expression": "`table_count`"}], "disaggregated": false}}],
            "spec": {
              "version": 3,
              "widgetType": "bar",
              "encodings": {
                "x": {"fieldName": "size_bucket", "displayName": "Size Range", "scale": {"type": "categorical"}},
                "y": {"fieldName": "table_count", "displayName": "Table Count", "scale": {"type": "quantitative"}}
              },
              "frame": {"showTitle": true, "title": "Table Size Distribution", "description": "Number of tables by size range"}
            }
          },
          "position": {"x": 0, "y": 2, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "chart_file_distribution",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_file_buckets", "fields": [{"name": "file_bucket", "expression": "`file_bucket`"}, {"name": "table_count", "expression": "`table_count`"}], "disaggregated": false}}],
            "spec": {
              "version": 3,
              "widgetType": "pie",
              "encodings": {
                "angle": {"fieldName": "table_count", "displayName": "Tables", "scale": {"type": "quantitative"}},
                "color": {"fieldName": "file_bucket", "displayName": "File Count Range", "scale": {"type": "categorical"}}
              },
              "frame": {"showTitle": true, "title": "File Count Distribution", "description": "Tables by number of files"}
            }
          },
          "position": {"x": 3, "y": 2, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "table_largest",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_largest_tables", "fields": [{"name": "table_name", "expression": "`table_name`"}, {"name": "schema_name", "expression": "`schema_name`"}, {"name": "size_gb", "expression": "`size_gb`"}, {"name": "num_files", "expression": "`num_files`"}, {"name": "avg_file_mb", "expression": "`avg_file_mb`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Largest Tables", "description": "Top tables by storage size"},
              "encodings": {
                "columns": [
                  {"fieldName": "table_name", "title": "Table"},
                  {"fieldName": "schema_name", "title": "Schema"},
                  {"fieldName": "size_gb", "title": "Size (GB)"},
                  {"fieldName": "num_files", "title": "Files"},
                  {"fieldName": "avg_file_mb", "title": "Avg File (MB)"}
                ]
              },
              "itemsPerPage": 15
            }
          },
          "position": {"x": 0, "y": 8, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "table_needs_compaction",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_needs_compaction", "fields": [{"name": "table_name", "expression": "`table_name`"}, {"name": "schema_name", "expression": "`schema_name`"}, {"name": "size_gb", "expression": "`size_gb`"}, {"name": "num_files", "expression": "`num_files`"}, {"name": "optimization_status", "expression": "`optimization_status`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Tables Needing Optimization", "description": "Tables with many small files needing compaction"},
              "encodings": {
                "columns": [
                  {"fieldName": "table_name", "title": "Table"},
                  {"fieldName": "schema_name", "title": "Schema"},
                  {"fieldName": "size_gb", "title": "Size (GB)"},
                  {"fieldName": "num_files", "title": "Files"},
                  {"fieldName": "optimization_status", "title": "Status"}
                ]
              },
              "itemsPerPage": 15
            }
          },
          "position": {"x": 3, "y": 8, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "table_empty",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_empty_tables", "fields": [{"name": "table_name", "expression": "`table_name`"}, {"name": "schema_name", "expression": "`schema_name`"}, {"name": "created_at", "expression": "`created_at`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Empty Tables", "description": "Tables with zero rows"},
              "encodings": {
                "columns": [
                  {"fieldName": "table_name", "title": "Table"},
                  {"fieldName": "schema_name", "title": "Schema"},
                  {"fieldName": "created_at", "title": "Created", "type": "datetime", "dateTimeFormat": "yyyy-MM-dd"}
                ]
              },
              "itemsPerPage": 15
            }
          },
          "position": {"x": 0, "y": 14, "width": 6, "height": 6}
        }
      ]
    }
  ],
  "datasets": [
    {"name": "ds_summary", "query": "SELECT ROUND(SUM(storage_size_bytes) / (1024*1024*1024), 2) AS total_size_gb, COUNT(DISTINCT table_name) AS table_count FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage"},
    {"name": "ds_optimization_needed", "query": "SELECT COUNT(*) AS count FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage WHERE file_count > 100 AND COALESCE(avg_file_size_bytes, 0) < 32*1024*1024"},
    {"name": "ds_size_buckets", "query": "SELECT CASE WHEN storage_size_bytes < 1024*1024*1024 THEN '< 1 GB' WHEN storage_size_bytes < 10*1024*1024*1024 THEN '1-10 GB' WHEN storage_size_bytes < 100*1024*1024*1024 THEN '10-100 GB' ELSE '> 100 GB' END AS size_bucket, COUNT(*) AS table_count FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage GROUP BY CASE WHEN storage_size_bytes < 1024*1024*1024 THEN '< 1 GB' WHEN storage_size_bytes < 10*1024*1024*1024 THEN '1-10 GB' WHEN storage_size_bytes < 100*1024*1024*1024 THEN '10-100 GB' ELSE '> 100 GB' END ORDER BY size_bucket"},
    {"name": "ds_file_buckets", "query": "SELECT CASE WHEN file_count < 10 THEN '< 10 files' WHEN file_count < 100 THEN '10-100 files' WHEN file_count < 1000 THEN '100-1000 files' ELSE '> 1000 files' END AS file_bucket, COUNT(*) AS table_count FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage GROUP BY CASE WHEN file_count < 10 THEN '< 10 files' WHEN file_count < 100 THEN '10-100 files' WHEN file_count < 1000 THEN '100-1000 files' ELSE '> 1000 files' END ORDER BY file_bucket"},
    {"name": "ds_largest_tables", "query": "SELECT table_name, table_schema AS schema_name, ROUND(storage_size_bytes / (1024*1024*1024), 2) AS size_gb, file_count AS num_files, ROUND(COALESCE(avg_file_size_bytes, 0) / (1024*1024), 2) AS avg_file_mb FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage ORDER BY storage_size_bytes DESC LIMIT 20"},
    {"name": "ds_needs_compaction", "query": "SELECT table_name, table_schema AS schema_name, ROUND(storage_size_bytes / (1024*1024*1024), 2) AS size_gb, file_count AS num_files, CASE WHEN file_count > 1000 AND COALESCE(avg_file_size_bytes, 0) < 32*1024*1024 THEN 'NEEDS_COMPACTION' WHEN file_count > 100 AND COALESCE(avg_file_size_bytes, 0) < 16*1024*1024 THEN 'CONSIDER_COMPACTION' ELSE 'OK' END AS optimization_status FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage WHERE file_count > 50 AND COALESCE(avg_file_size_bytes, 0) < 64*1024*1024 ORDER BY file_count DESC LIMIT 25"},
    {"name": "ds_empty_tables", "query": "SELECT table_name, table_schema AS schema_name, last_modified_time AS created_at FROM ${catalog}.${gold_schema}.fact_information_schema_table_storage WHERE row_count = 0 OR row_count IS NULL ORDER BY table_name LIMIT 30"}
  ]
}



