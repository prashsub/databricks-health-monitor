{
  "displayName": "Cost Management Dashboard",
  "warehouse_id": "${warehouse_id}",
  "pages": [
    {
      "name": "page_cost_overview",
      "displayName": "Cost Overview",
      "layout": [
        {
          "widget": {
            "name": "kpi_total_dbu",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_kpi_dbu", "fields": [{"name": "total_dbu", "expression": "`total_dbu`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "total_dbu"}},
              "frame": {"showTitle": true, "title": "Total DBU (MTD)"}
            }
          },
          "position": {"x": 0, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "kpi_tag_coverage",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_tag_coverage", "fields": [{"name": "coverage_pct", "expression": "`coverage_pct`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "coverage_pct"}},
              "frame": {"showTitle": true, "title": "Tag Coverage", "description": "% of cost with tags"}
            }
          },
          "position": {"x": 2, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "kpi_serverless_ratio",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_serverless", "fields": [{"name": "serverless_pct", "expression": "`serverless_pct`"}], "disaggregated": false}}],
            "spec": {
              "version": 2,
              "widgetType": "counter",
              "encodings": {"value": {"fieldName": "serverless_pct"}},
              "frame": {"showTitle": true, "title": "Serverless Adoption"}
            }
          },
          "position": {"x": 4, "y": 0, "width": 2, "height": 2}
        },
        {
          "widget": {
            "name": "table_top_contributors",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_top_contributors", "fields": [{"name": "workspace_name", "expression": "`workspace_name`"}, {"name": "sku_name", "expression": "`sku_name`"}, {"name": "total_cost", "expression": "`total_cost`"}, {"name": "total_dbu", "expression": "`total_dbu`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Top Cost Contributors"},
              "encodings": {
                "columns": [
                  {"fieldName": "workspace_name", "title": "Workspace"},
                  {"fieldName": "sku_name", "title": "SKU"},
                  {"fieldName": "total_cost", "title": "Cost ($)"},
                  {"fieldName": "total_dbu", "title": "DBU"}
                ]
              },
              "itemsPerPage": 20
            }
          },
          "position": {"x": 0, "y": 2, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "chart_wow_growth",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_wow", "fields": [{"name": "week_start", "expression": "`week_start`"}, {"name": "weekly_cost", "expression": "`weekly_cost`"}, {"name": "wow_growth_pct", "expression": "`wow_growth_pct`"}], "disaggregated": false}}],
            "spec": {
              "version": 3,
              "widgetType": "bar",
              "encodings": {
                "x": {"fieldName": "week_start", "displayName": "Week", "scale": {"type": "temporal"}},
                "y": {"fieldName": "weekly_cost", "displayName": "Cost ($)", "scale": {"type": "quantitative"}}
              },
              "frame": {"showTitle": true, "title": "Week-over-Week Cost"}
            }
          },
          "position": {"x": 3, "y": 2, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "table_cost_by_owner",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_by_owner", "fields": [{"name": "owner", "expression": "`owner`"}, {"name": "total_cost", "expression": "`total_cost`"}, {"name": "job_count", "expression": "`job_count`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Cost by Owner"},
              "encodings": {
                "columns": [
                  {"fieldName": "owner", "title": "Owner"},
                  {"fieldName": "total_cost", "title": "Cost ($)"},
                  {"fieldName": "job_count", "title": "Jobs"}
                ]
              },
              "itemsPerPage": 15
            }
          },
          "position": {"x": 0, "y": 8, "width": 3, "height": 6}
        },
        {
          "widget": {
            "name": "table_untagged",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_untagged", "fields": [{"name": "workspace_name", "expression": "`workspace_name`"}, {"name": "untagged_cost", "expression": "`untagged_cost`"}], "disaggregated": false}}],
            "spec": {
              "version": 1,
              "widgetType": "table",
              "frame": {"showTitle": true, "title": "Untagged Resources"},
              "encodings": {
                "columns": [
                  {"fieldName": "workspace_name", "title": "Workspace"},
                  {"fieldName": "untagged_cost", "title": "Untagged Cost ($)"}
                ]
              },
              "itemsPerPage": 10
            }
          },
          "position": {"x": 3, "y": 8, "width": 3, "height": 6}
        }
      ]
    }
  ],
  "datasets": [
    {"name": "ds_kpi_dbu", "query": "SELECT FORMAT_NUMBER(SUM(usage_quantity), 0) AS total_dbu FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= DATE_TRUNC('month', CURRENT_DATE())"},
    {"name": "ds_tag_coverage", "query": "SELECT CONCAT(ROUND(SUM(CASE WHEN is_tagged THEN list_cost ELSE 0 END) * 100.0 / NULLIF(SUM(list_cost), 0), 1), '%') AS coverage_pct FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS"},
    {"name": "ds_serverless", "query": "SELECT CONCAT(ROUND(SUM(CASE WHEN product_features_is_serverless THEN list_cost ELSE 0 END) * 100.0 / NULLIF(SUM(list_cost), 0), 1), '%') AS serverless_pct FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS"},
    {"name": "ds_top_contributors", "query": "SELECT w.workspace_name, f.sku_name, ROUND(SUM(f.list_cost), 2) AS total_cost, ROUND(SUM(f.usage_quantity), 2) AS total_dbu FROM ${catalog}.${gold_schema}.fact_usage f LEFT JOIN ${catalog}.${gold_schema}.dim_workspace w ON f.workspace_id = w.workspace_id AND w.is_current = TRUE WHERE f.usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS GROUP BY w.workspace_name, f.sku_name ORDER BY total_cost DESC LIMIT 20"},
    {"name": "ds_wow", "query": "SELECT DATE_TRUNC('week', usage_date) AS week_start, SUM(list_cost) AS weekly_cost, (SUM(list_cost) - LAG(SUM(list_cost)) OVER (ORDER BY DATE_TRUNC('week', usage_date))) * 100.0 / NULLIF(LAG(SUM(list_cost)) OVER (ORDER BY DATE_TRUNC('week', usage_date)), 0) AS wow_growth_pct FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 90 DAYS GROUP BY DATE_TRUNC('week', usage_date) ORDER BY week_start"},
    {"name": "ds_by_owner", "query": "SELECT identity_metadata_owned_by AS owner, ROUND(SUM(list_cost), 2) AS total_cost, COUNT(DISTINCT usage_metadata_job_id) AS job_count FROM ${catalog}.${gold_schema}.fact_usage WHERE usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS AND identity_metadata_owned_by IS NOT NULL GROUP BY identity_metadata_owned_by ORDER BY total_cost DESC LIMIT 20"},
    {"name": "ds_untagged", "query": "SELECT w.workspace_name, ROUND(SUM(f.list_cost), 2) AS untagged_cost FROM ${catalog}.${gold_schema}.fact_usage f LEFT JOIN ${catalog}.${gold_schema}.dim_workspace w ON f.workspace_id = w.workspace_id AND w.is_current = TRUE WHERE f.usage_date >= CURRENT_DATE() - INTERVAL 30 DAYS AND f.is_tagged = FALSE GROUP BY w.workspace_name ORDER BY untagged_cost DESC LIMIT 15"}
  ]
}
