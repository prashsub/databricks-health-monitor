---
description: Patterns and best practices for creating Table-Valued Functions (TVFs) in Databricks optimized for Genie Space natural language queries
---

# Databricks Table-Valued Functions (TVFs) for Genie

## Pattern Recognition
Table-Valued Functions (TVFs) in Databricks have specific requirements when used with Genie Spaces for natural language queries. This rule standardizes TVF creation to ensure Genie compatibility and SQL compliance.

## Critical SQL Requirements

### ⚠️ Issue 1: Parameter Types for Genie Compatibility

**RULE: Use STRING for date parameters, not DATE**

Genie Spaces do not support DATE type parameters. Always use STRING with explicit format documentation.

#### ❌ DON'T: Use DATE parameters
```sql
CREATE OR REPLACE FUNCTION get_sales_by_date_range(
  start_date DATE COMMENT 'Start date',
  end_date DATE COMMENT 'End date'
)
...
WHERE transaction_date BETWEEN start_date AND end_date
```

**Error:**
```
Parameter start_date has an unsupported type: date
Parameter end_date has an unsupported type: date
```

#### ✅ DO: Use STRING parameters with CAST
```sql
CREATE OR REPLACE FUNCTION get_sales_by_date_range(
  start_date STRING COMMENT 'Start date (format: YYYY-MM-DD)',
  end_date STRING COMMENT 'End date (format: YYYY-MM-DD)'
)
...
WHERE transaction_date BETWEEN CAST(start_date AS DATE) AND CAST(end_date AS DATE)
```

**Benefits:**
- ✅ Works with Genie natural language processing
- ✅ Clear format documentation for users
- ✅ Type-safe conversion inside function

---

### ⚠️ Issue 2: Parameter Ordering with DEFAULT Values

**RULE: Parameters with DEFAULT must come AFTER parameters without DEFAULT**

SQL functions require all required parameters first, optional parameters last.

#### ❌ DON'T: Mix DEFAULT and non-DEFAULT parameters
```sql
CREATE OR REPLACE FUNCTION get_top_stores(
  top_n INT DEFAULT 10,          -- ❌ DEFAULT parameter first
  start_date STRING,              -- ❌ Required parameter after DEFAULT
  end_date STRING                 -- ❌ Required parameter after DEFAULT
)
```

**Error:**
```
[USER_DEFINED_FUNCTIONS.NOT_A_VALID_DEFAULT_PARAMETER_POSITION]
User defined function is invalid: parameter with DEFAULT must not be 
followed by parameter without DEFAULT.
```

#### ✅ DO: Required parameters first, optional last
```sql
CREATE OR REPLACE FUNCTION get_top_stores(
  start_date STRING,              -- ✅ Required parameter first
  end_date STRING,                -- ✅ Required parameter
  top_n INT DEFAULT 10            -- ✅ Optional parameter last
)
```

**Parameter Order Rules:**
1. All required parameters (no DEFAULT)
2. All optional parameters (with DEFAULT)
3. Never mix the two groups

---

### ⚠️ Issue 3: LIMIT Clauses Cannot Use Parameters

**RULE: Use WHERE rank <= parameter instead of LIMIT parameter**

LIMIT clauses require compile-time constants. Use WHERE with ROW_NUMBER() instead.

#### ❌ DON'T: Use parameter in LIMIT clause
```sql
RETURN
  WITH store_metrics AS (
    SELECT ...,
      ROW_NUMBER() OVER (ORDER BY total_revenue DESC) as rank
    FROM ...
  )
  SELECT * FROM store_metrics
  ORDER BY total_revenue DESC
  LIMIT top_n;  -- ❌ Cannot use parameter here
```

**Error:**
```
[INVALID_LIMIT_LIKE_EXPRESSION.IS_UNFOLDABLE]
The limit like expression "outer(get_top_stores.top_n)" is invalid.
The limit expression must evaluate to a constant value.
```

#### ✅ DO: Use WHERE clause with rank
```sql
RETURN
  WITH store_metrics AS (
    SELECT ... FROM ...
  ),
  ranked_stores AS (
    SELECT ...,
      ROW_NUMBER() OVER (ORDER BY total_revenue DESC) as rank
    FROM store_metrics
  )
  SELECT * FROM ranked_stores
  WHERE rank <= top_n  -- ✅ Can use parameter in WHERE
  ORDER BY rank;
```

**Why This Works:**
- `LIMIT` is evaluated at compile-time (needs constant)
- `WHERE` is evaluated at runtime (can use parameters)
- `WHERE rank <= N` achieves same result as `LIMIT N`

---

## LLM-Friendly Metadata Pattern

**RULE: Always include comprehensive COMMENT metadata for Genie**

Every TVF should have rich metadata to help Genie understand when and how to use it.

### Function-Level Comment Template

```sql
COMMENT 'LLM: [Brief description]. Use this for [use cases]. 
Parameters: [parameter list with formats]. 
Example: "[Natural language question 1]" or "[Natural language question 2]"'
```

### Complete Example

```sql
CREATE OR REPLACE FUNCTION get_top_stores_by_revenue(
  start_date STRING COMMENT 'Start date (format: YYYY-MM-DD)',
  end_date STRING COMMENT 'End date (format: YYYY-MM-DD)',
  top_n INT DEFAULT 10 COMMENT 'Number of top stores to return'
)
RETURNS TABLE(
  rank INT COMMENT 'Store rank by revenue',
  store_number STRING COMMENT 'Store identifier',
  store_name STRING COMMENT 'Store name',
  total_revenue DECIMAL(18,2) COMMENT 'Total revenue for period',
  total_units BIGINT COMMENT 'Total units sold',
  transaction_count BIGINT COMMENT 'Number of transactions',
  avg_transaction_value DECIMAL(18,2) COMMENT 'Average transaction value'
)
COMMENT 'LLM: Returns the top N stores ranked by revenue for a date range. 
Use this for store performance analysis, regional comparisons, and identifying 
best performers. Parameters: start_date, end_date, optional top_n (default 10). 
Example: "What are the top 10 stores by revenue this month?" or 
"Show me the best performing stores"'
RETURN
  WITH store_metrics AS (
    SELECT ... FROM ...
  ),
  ranked_stores AS (
    SELECT ...,
      ROW_NUMBER() OVER (ORDER BY total_revenue DESC) as rank
    FROM store_metrics
  )
  SELECT * FROM ranked_stores
  WHERE rank <= top_n
  ORDER BY rank;
```

**Metadata Requirements:**
- ✅ Function COMMENT: LLM-friendly description with use cases and examples
- ✅ Parameter COMMENT: Clear description with format for strings
- ✅ Column COMMENT: Business-friendly description for each returned column
- ✅ Example questions: Natural language patterns Genie should recognize

---

## Complete TVF Pattern (All Rules Applied)

```sql
-- Function: Get top performing stores by revenue
CREATE OR REPLACE FUNCTION get_top_stores_by_revenue(
  -- Required parameters first (no DEFAULT)
  start_date STRING COMMENT 'Start date (format: YYYY-MM-DD)',
  end_date STRING COMMENT 'End date (format: YYYY-MM-DD)',
  -- Optional parameters last (with DEFAULT)
  top_n INT DEFAULT 10 COMMENT 'Number of top stores to return'
)
RETURNS TABLE(
  -- Every column documented
  rank INT COMMENT 'Store rank by revenue',
  store_number STRING COMMENT 'Store identifier',
  store_name STRING COMMENT 'Store name',
  total_revenue DECIMAL(18,2) COMMENT 'Total revenue for period',
  total_units BIGINT COMMENT 'Total units sold',
  transaction_count BIGINT COMMENT 'Number of transactions',
  avg_transaction_value DECIMAL(18,2) COMMENT 'Average transaction value',
  unique_products BIGINT COMMENT 'Number of unique products sold'
)
-- LLM-friendly function comment
COMMENT 'LLM: Returns the top N stores ranked by revenue for a date range. 
Use this for store performance analysis, regional comparisons, and identifying 
best performers. Parameters: start_date, end_date, optional top_n (default 10). 
Example: "What are the top 10 stores by revenue this month?" or 
"Show me the best performing stores"'
RETURN
  WITH store_metrics AS (
    SELECT 
      store_number,
      store_name,
      SUM(net_revenue) as total_revenue,
      SUM(net_units) as total_units,
      SUM(transaction_count) as transaction_count,
      COUNT(DISTINCT upc_code) as unique_products
    FROM fact_sales_daily
    -- Cast STRING dates to DATE for comparison
    WHERE transaction_date BETWEEN CAST(start_date AS DATE) AND CAST(end_date AS DATE)
    GROUP BY store_number, store_name
  ),
  ranked_stores AS (
    SELECT 
      ROW_NUMBER() OVER (ORDER BY total_revenue DESC) as rank,
      store_number,
      store_name,
      total_revenue,
      total_units,
      transaction_count,
      total_revenue / NULLIF(transaction_count, 0) as avg_transaction_value,
      unique_products
    FROM store_metrics
  )
  -- Use WHERE rank <= parameter instead of LIMIT parameter
  SELECT * FROM ranked_stores
  WHERE rank <= top_n
  ORDER BY rank;
```

---

## Null Safety Best Practices

**RULE: Always use NULLIF() for division to prevent divide-by-zero errors**

```sql
-- ❌ DON'T: Direct division
total_revenue / transaction_count as avg_transaction_value

-- ✅ DO: Null-safe division
total_revenue / NULLIF(transaction_count, 0) as avg_transaction_value
```

---

## SCD Type 2 Dimension Handling

**RULE: Always filter for current records when joining SCD2 dimensions**

```sql
-- ✅ Correct: Filter for current version
LEFT JOIN dim_store ds 
  ON fsd.store_number = ds.store_number 
  AND ds.is_current = true
```

---

## TVF Creation Checklist

When creating Table-Valued Functions for Genie:

### SQL Compliance
- [ ] All date parameters are STRING type (not DATE)
- [ ] Required parameters come before optional parameters
- [ ] No parameters used in LIMIT clauses (use WHERE rank <= param)
- [ ] All divisions use NULLIF to prevent divide-by-zero
- [ ] SCD2 joins include `is_current = true` filter

### Genie Optimization
- [ ] Function COMMENT starts with "LLM:"
- [ ] Function COMMENT includes use cases
- [ ] Function COMMENT includes 2+ example questions
- [ ] All parameters have descriptive COMMENT
- [ ] String parameters include format (e.g., "format: YYYY-MM-DD")
- [ ] All returned columns have COMMENT
- [ ] Column names are business-friendly

### Testing
- [ ] Function compiles without errors
- [ ] Function executes with valid parameters
- [ ] Function handles edge cases (empty results, null values)
- [ ] Function tested in Genie Space (if applicable)

---

## Common Mistakes to Avoid

### ❌ Mistake 1: Using DATE parameters
```sql
-- Will fail in Genie
start_date DATE COMMENT 'Start date'
```

### ❌ Mistake 2: Wrong parameter order
```sql
-- Will fail to compile
CREATE FUNCTION func(
  optional_param INT DEFAULT 10,
  required_param STRING
)
```

### ❌ Mistake 3: Parameter in LIMIT
```sql
-- Will fail to compile
SELECT * FROM data
LIMIT top_n
```

### ❌ Mistake 4: No null safety
```sql
-- Can fail with divide by zero
revenue / transactions
```

### ❌ Mistake 5: Poor Genie metadata
```sql
-- Won't be discoverable by Genie
COMMENT 'Gets data'
```

---

## References

### Official Documentation
- [Databricks Table-Valued Functions](https://docs.databricks.com/sql/language-manual/sql-ref-syntax-qry-select-tvf)
- [Genie Trusted Assets - Functions](https://docs.databricks.com/genie/trusted-assets#tips-for-writing-functions)
- [SQL UDF Best Practices](https://docs.databricks.com/sql/language-manual/sql-ref-syntax-ddl-create-sql-function)

### Project Examples
- [table_valued_functions.sql](../../altriaDeltaShare/src/altria_gold/table_valued_functions.sql) - 15 production TVFs
- [TVF_ENHANCEMENTS_SUMMARY.md](../../altriaDeltaShare/docs/gold/TVF_ENHANCEMENTS_SUMMARY.md) - Complete fix documentation
- [GENIE_SPACE_SETUP_GUIDE.md](../../altriaDeltaShare/docs/gold/GENIE_SPACE_SETUP_GUIDE.md) - Genie integration guide

---

## Version History

- **v1.0** (Oct 2025) - Initial rule based on 15 TVF deployment learnings
  - 3 critical SQL issues identified and resolved
  - Genie compatibility patterns established
  - Production-tested with successful deployment
